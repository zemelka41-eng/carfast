# ADMIN STOCK & PRODUCTS GUIDE (CARFST)

Документ для менеджеров/контент‑редакторов: как вести карточки техники (Product) и как обновлять остатки/цены по городам через импорт XLSX.

---

## 1) Вход в админку (/admin/) и роли

1. Откройте админку: `/admin/`.
2. Войдите под учётной записью **staff**.

Роли (по смыслу):
- **Контент‑редактор**: правит карточки товара (описание/фото/SEO), может менять остатки в карточке.
- **Менеджер**: загружает XLSX с остатками, проверяет, что «в наличии» и цены отображаются на сайте.

---

## 2) Карточка товара (Product): что это и как создавать

### Что такое Product
**Product** — это «витрина»: описание модели/комплектации (SEO, тексты, фото). Остатки и цены по городам хранятся отдельно в **Offer**.

На сайте:
- В каталоге показывается **«Цена от» (минимальная)** среди активных предложений.
- Фильтр **«В наличии»** работает по сумме количества **по предложениям**.

### Когда создавать вручную
Создавайте карточку вручную, если нужно:
- добавить **описание**, преимущества, характеристики;
- загрузить **фото**;
- настроить **URL (slug)** и контент.

### Когда карточка создастся автоматически
При импорте остатков из XLSX система может **создать карточку автоматически**, если её ещё не было.

### Обязательные поля (логически)
В админке у товара важны:
- **Бренд (Series)**
- **Категория (Category)**
- **model_code** — код модели (из XLSX «Модель»)
- **title** (в админке это заголовок; фактически хранится как `model_name_ru`)
- **config** — текст комплектации (нормализованный)

### Как проверить, что карточка появилась на сайте
1. Откройте каталог: `/catalog/`
2. Убедитесь, что карточка есть в выдаче.
3. Для бренда: `/brands/<slug>/` (например: `/brands/shacman/`).

---

## 3) Ручное управление остатками (Offer) в карточке

Где править:
1. Админка → **Catalog → Техника (Product)**
2. Откройте нужный товар
3. Внизу страницы есть таблица **OfferInline** (предложения)

Что означает Offer:
- **city** — город
- **qty** — количество (остаток)
- **price** — цена (если пусто, на сайте будет «по запросу»)
- **vat** — отметка НДС (по умолчанию «с НДС»)
- **year** — год (если удалось определить)
- **is_active** — активно ли предложение

Как работает «В наличии»:
- **В наличии** = сумма `qty` по **активным** предложениям (`is_active=True`) больше 0.

---

## 4) Импорт остатков из XLSX

### Где загрузить файл
Импорт доступен только staff.

1. Откройте страницу импорта: `/admin/import-stock/`
2. Выберите XLSX файл
3. Опции:
   - **Dry-run (без записи)** — показать отчёт, не меняя базу.
   - **Deactivate-missing** — деактивировать предложения из этого же файла, которые отсутствуют в новой версии.
4. Нажмите **«Импортировать»**

После выполнения вы увидите отчёт:
- сколько создано/обновлено **Series/Category/City/Product/Offer**
- сколько **деактивировано Offer**
- список ошибок по строкам

### Что такое dry-run
Dry-run полезен, чтобы:
- проверить, что файл читается;
- увидеть, сколько сущностей создастся/обновится;
- увидеть ошибки по строкам.

### Что такое deactivate-missing
Если включено:
- предложения (Offer), которые **раньше были активны** и пришли из **того же source_file**, но **не встретились** в новом импорте, станут `is_active=False`.

Это нужно, чтобы «старые остатки» не продолжали показываться на сайте.

---

## 4.1) Текущий формат XLSX «КАРФАСТ» (формат #1)

Ожидаемые колонки (как в реальном файле):
- **A: Наименование**
- **B: Модель**
- **D: Комплектация**
- **J: Цена с НДС, руб.** (например: `8 590 000 ₽`)
- **K: Наличие** (например: `г.Москва`, `г. Саратов`, иногда переносы строк)

Строки‑разделители:
- бывают строки без «Модель», например `САМОСВАЛЫ SHACMAN`, `ТЯГАЧИ SHACMAN`, `DAYUN`.
- такие строки **не импортируются как товар**, но используются как контекст для бренда/категории.

### Как считается количество (qty)
В файле отдельной колонки qty нет.
Правило:
- **каждая строка с заполненной «Модель» = 1 единица**
- одинаковые строки агрегируются в одно предложение (Offer) с `qty = количество строк`

Пример (в XLSX два одинаковых ряда):
- `Самосвал SHACMAN X3000 | X3000 | ... | 8 590 000 ₽ | г.Москва`
- `Самосвал SHACMAN X3000 | X3000 | ... | 8 590 000 ₽ | г.Москва`

Результат:
- Offer (Москва) будет с `qty = 2`.

### Как определяется бренд
State machine (упрощённо):
- если строка‑разделитель содержит **SHACMAN** → бренд = `shacman`
- если строка‑разделитель содержит **DAYUN** → бренд = `dayun`
- если строка товара начинается с **DAYUN ...** → бренд = `dayun`
- иначе берётся текущий бренд из разделителя
- если не определён → бренд = `other`

### Как определяется категория
По разделителям и эвристике по «Наименование»:
- разделитель `САМОСВАЛЫ ...` → `samosvaly`
- `ТЯГАЧИ ...` → `tyagachi`
- `Автобетоносмесители ...` → `abs`
- `КМУ ...` → `kmu`
- `ЗЕРНОВОЗЫ ...` → `zernovozy`
- иначе (по названию товара): «самосвал», «тягач», «кму», «зерновоз», «трактор», «фургон»
- если не определилось → `tehnika`

---

## 4.2) Будущий «нормализованный шаблон» (формат #2)

Если в файле есть колонки:
`brand, category, title, model_code, config, city, qty, price, vat, year`
— они используются напрямую.

Рекомендация: если появится такой шаблон, храните **brand/category** как текст (система создаст Series/Category при необходимости).

---

## 5) Типовые ошибки и решения

### Товар не появился
Проверьте:
- в строке XLSX заполнена «**Модель**» (иначе строка считается разделителем и пропускается)
- товар не выключен: `Product.is_active=True` и `Product.published=True`
- бренд/категория определились (если нет — попадёт в `other/tehnika`)

### Цена не отображается
Причины:
- в строке цена пустая или не распарсилась (например, странные символы)

Решение:
- проверьте колонку **«Цена с НДС, руб.»**
- в Offer можно задать price вручную

### Фото не загружается (.jfif / “disallowed extension”)
Причина:
- некоторые телефоны/мессенджеры сохраняют фото с расширением **.jfif** (это JPEG), а сайт может блокировать неизвестные расширения.

Решение:
- проще всего **конвертировать/пересохранить** файл в **.jpg/.png/.webp** (или просто переименовать `.jfif` → `.jpg`, если это JPEG);
- если вы администрируете сервер и используете строгий список расширений, добавьте `jfif` в `MEDIA_ALLOWED_IMAGE_EXTENSIONS`.

### Город «кривой»
Причины:
- переносы строк, лишнее `г.`/`г.`

Решение:
- в XLSX поправить значение в колонке «Наличие»
- или вручную поправить City/Offer в админке

---

## 6) Чеклист после импорта

1. Каталог «в наличии»: `/catalog/?availability=in_stock`
2. Бренд‑страница: `/brands/shacman/` (популярные позиции сортируются по total_qty)
3. Карточка товара:
   - «Цена от»
   - «Наличие: В наличии» или «Под заказ»
   - блок **«Наличие по городам»** (статус вместо количества)
