# C5 — Дубли (duplicate_group): стратегия и план внедрения

## Правила выбора «главного» URL в группе дублей

Группа дубля: одинаковые **category_slug + model_code + wheel_formula + engine + year**.

Приоритет выбора главного URL:

1. **In-stock** приоритетнее «под заказ».
2. Более **полный slug** (модель + формула + двигатель).
3. Наличие **цены** и/или **города** (если есть в данных).
4. Более **новый год** (max year по офферам).

Действия с остальными URL в группе:

- **301 на главный** — если различия косметические (один и тот же товар, разная подача).
- **Canonical на главный** — если 301 рискован (разные регионы/сайты) или нужна осторожность.
- **Оставить** — если реально разные комплектации/цены; обеспечить уникальность текста/FAQ и явные отличия в контенте.

Реализация не должна нарушать SEO-инварианты: canonical по request.path, без schema на URL с GET, page=1 → редирект, page>1 → noindex.

---

## Таблица дублей (топ-20) — шаблон для подстановки с проды

После запуска на проде команды:

```bash
python manage.py seo_audit_shacman --all --csv reports/shacman_inventory_<DATE>.csv
```

секция **Duplicate / cannibalization** выводит группы. Ниже — шаблон таблицы для топ-20 групп.

| № | Группа (cat \| code \| formula \| engine \| year) | Кол-во URL | Главный URL (рекомендация) | Действие с остальными |
|---|---------------------------------------------------|------------|----------------------------|------------------------|
| 1 | *samosvaly \| SX... \| 6x4 \| WP12 \| 2023* | *2* | */product/.../ (in-stock, с ценой)* | *301 на главный* |
| 2 | *...* | *...* | *...* | *canonical / оставить* |
| ... | ... | ... | ... | ... |

*(Заполнить после получения вывода с проды; при отсутствии дублей таблица пустая.)*

---

## План внедрения

1. **Получить список дублей** — `seo_audit_shacman --all`, секция Duplicate.
2. **Для каждой группы** — определить главный URL по правилам выше.
3. **Решения:**
   - 301: в nginx или во вьюхе (редирект со slug дубликата на slug главного) — аккуратно, чтобы не зациклить и не сломать canonical.
   - Canonical: оставить все URL, в шаблоне product_detail для «не главных» выставлять canonical на главный (требует хранения/вычисления «главного» в группе).
   - Оставить без редиректа: уникализировать Title/Description/FAQ для каждого URL.
4. **Проверки после внедрения:** curl главного и дублей, проверка canonical и отсутствия schema на GET.
