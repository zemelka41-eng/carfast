## Гайд: как загружать наличие и создавать карточки техники (CARFAST)

Этот документ объясняет, как устроены сущности в админке и как быстро:
- создать структуру (Категории → Серии/бренды → Техника);
- добавить изображения;
- завести/обновить наличие и цены (вручную и через импорт XLSX);
- что проверить после изменений на сервере.

---

## 1) Как связаны сущности в БД

- **Category** — категория техники (например: Самосвалы, Тягачи).
- **Series** — бренд/серия (например: SHACMAN).
- **Product** — карточка техники (витрина): название, описание, SEO, публикация.
  - У `Product` есть связи: **Series** (бренд) и **Category** (категория).
- **ProductImage** — изображения товара (несколько файлов на один `Product`).
- **City** — город.
- **Offer** — предложение/остаток: `qty`, `price`, `vat`, `year`, `is_active` **в разрезе города**.
  - `Offer` связан с `Product` и `City`.

На сайте:
- «**Цена от**» берётся как **минимальная цена среди активных Offer**.
- Фильтр «**В наличии**» работает по **сумме qty по активным Offer**.

---

## 2) Создание структуры (Категория → Серия → Техника)

### 2.1 Категории (Category)
1. Админка → **Catalog → Category** → **Add**.
2. Заполните **Name** и **Slug** (slug — латиница, без пробелов).

### 2.2 Бренды/серии (Series)
1. Админка → **Catalog → Series** → **Add**.
2. Заполните **Name** и **Slug**.
3. (Опционально) заполните **History** — это текст на странице бренда.

### 2.3 Карточка техники (Product)
1. Админка → **Catalog → Product** → **Add**.
2. Заполните минимум:
   - **SKU**
   - **Slug**
   - **Model name (RU)**
   - **Series** (бренд)
   - **Category** (категория)
3. Чтобы товар отображался на сайте, проверьте:
   - **Published = True**
   - **Is active = True**

---

## 3) Как добавить изображения товара

Вариант (рекомендуется): через карточку товара.
1. Админка → **Catalog → Product** → откройте нужный товар.
2. Внизу страницы — блок **Product images**.
3. Добавьте строки:
   - **image** — файл
   - **order** — порядок (0 = главное фото)
   - **alt_ru / alt_en** — подписи
4. Сохраните товар.

**Подробнее:** См. [Гайд по подготовке фото](PHOTO_GUIDE.md) — форматы, размеры, правила именования файлов.

---

## 4) Наличие/остатки (Offer): вручную

Где править:
- Админка → **Catalog → Product** → открыть товар → блок **Offers** (внизу),
  или Админка → **Catalog → Offer**.

Поля Offer:
- **city** — город
- **qty** — количество
- **price** — цена (если пусто, на сайте будет «по запросу»)
- **vat** — пометка НДС (по умолчанию «с НДС»)
- **year** — год (опционально)
- **is_active** — участвует ли предложение в показе на сайте

---

## 5) Импорт остатков из XLSX (рекомендуется)

### 5.1 Где находится импорт в админке
- Откройте страницу: **`/admin/import-stock/`**
- Параметры:
  - **Dry-run (без записи)** — покажет отчёт, не меняя БД
  - **Deactivate-missing** — если включено, предложения из этого же файла, которых нет в новом импорте, станут `is_active=False`

### 5.2 Поддерживаемые форматы файла (по коду импорта)

Импорт поддерживает **2 формата**:

#### Формат A: «КАРФАСТ» (человеческий)
Ожидаются колонки (по заголовкам):
- **Наименование**
- **Модель**
- **Комплектация**
- **Цена ... НДС ...** (имя колонки может отличаться, важно чтобы в заголовке были слова «цена» и «ндс»)
- **Наличие** (город)

Если заголовков нет/они нестандартные, есть fallback по позициям колонок **A,B,D,J,K**.

Правила:
- Строки без «Модель» считаются **разделителями** (задают текущий бренд/категорию) и не импортируются как товар.
- Каждая строка товара в этом формате даёт `qty = 1`.
  Одинаковые строки агрегируются в одно предложение (Offer) с суммарным `qty`.

Определение бренда:
- Разделитель с **SHACMAN** → `brand_slug = shacman`
- Разделитель с **DAYUN** → `brand_slug = dayun`
- Иначе используется текущий бренд из разделителя; если его нет — `other`

Определение категории:
- По разделителям (например: `САМОСВАЛЫ…`, `ТЯГАЧИ…`, `КМУ…`, `ЗЕРНОВОЗЫ…` и т.д.)
- Либо по названию (самосвал/тягач/трактор/фургон и т.п.)

#### Формат B: «нормализованный шаблон»
Если в первой строке есть заголовки **`model_code`** и **`city`**, импорт работает как нормализованный.
Рекомендуемые колонки:
- `brand`, `category`, `title`, `model_code`, `config`, `city`, `qty`, `price`, `vat`, `year`

---

## 6) Импорт карточек товаров (Product) из XLSX (опционально)

Есть команда:
- `python manage.py import_products <file_path.xlsx> [media_dir]`

Ожидаемые колонки в XLSX (первая строка):
- `sku`, `slug`, `series`, `category`, `model_name_ru`, `model_name_en`, `short_description_ru`, `short_description_en`, `price`, `availability`, `image`

Про изображения:
- `media_dir` — каталог, где лежат файлы из колонки `image` (может быть относительным).
- Картинка прикрепится как **главная** (`order = 0`).

---

## 7) (Опционально) Как убрать SITRAK из БД, если он уже создан

В проект добавлена команда:
- `python manage.py remove_sitrak --dry-run`
- `python manage.py remove_sitrak --delete-series`

Что она делает:
- помечает все товары бренда `sitrak` как `published=False` и `is_active=False`;
- деактивирует связанные предложения (`Offer.is_active=False`);
- при `--delete-series` удаляет `Series` со slug `sitrak`.

---

## 8) После изменений на сервере (кратко)

1. Применить миграции:
   - `python manage.py migrate`
2. Собрать статику:
   - `python manage.py collectstatic --noinput`
3. Перезапустить приложение (gunicorn/docker — по вашей схеме деплоя).

Проверка после импорта:
- `/catalog/?availability=in_stock`
- `/brands/shacman/`
- любая карточка товара `/product/<slug>/`
