# Сводка финальных исправлений команды move_images_to_content

## Исправленные проблемы

### 1. Синтаксические ошибки

**Исправлено:**
- ✅ Строка 23: `.replace(''','"')` → `.replace('\u2019', "'")` (правильное экранирование кавычек)
- ✅ Функция `_build_figure_html`: заменён тройной кавычки на `'\n'.join([...])` для избежания проблем с кавычками
- ✅ Все regex-строки используют raw strings (`r"..."`) или правильно экранированы

**Проверка:**
```bash
python -m compileall blog/management/commands/move_images_to_content.py
# Должно компилироваться без ошибок
```

### 2. Поиск изображений по базовым именам

**Реализовано:**
- Построение списка базовых имён:
  - `slug` (например `shacman-x3000-8x4-komplektaciya`)
  - Вариант без первого префикса до `-` (например `x3000-8x4-komplektaciya`)
- Поиск изображений по паттерну: `{base}_{n}.(png|jpg|jpeg|webp)` или `{base}_{n}_<any>.(png|jpg|jpeg|webp)`
- Проверка на дубликаты: если найдено больше одного кандидата на индекс — ошибка с списком кандидатов

**Пример:**
- Slug: `shacman-x3000-8x4-komplektaciya`
- Базовые имена: `['shacman-x3000-8x4-komplektaciya', 'x3000-8x4-komplektaciya']`
- Найдёт файлы: `x3000-8x4-komplektaciya_2.png`, `x3000-8x4-komplektaciya_3.png`, `x3000-8x4-komplektaciya_4.png`

### 3. Упрощённые якоря вставки

**Image 2:**
- Поиск: `Типовые\s+сценарии[^<]*[""«»„"][^<]*стройка` (учитывает типографские кавычки)
- Fallback: просто `Типовые\s+сценарии`
- Вставка перед найденным текстом

**Image 3:**
- Поиск: `1\)\s*Площадка` (прямой поиск текста)
- Fallback: параграф с `5\s+параметров`, вставка после него
- Вставка перед найденным текстом

**Image 4:**
- Поиск: `Чек-лист\s+при[её]мки` (учитывает вариацию е/ё)
- Вставка перед найденным текстом

**Преимущества:**
- Работает с типографскими кавычками (`""`, `«»`)
- Работает с HTML-атрибутами тегов
- Работает с вариациями символов (е/ё)
- Не требует сложного парсинга HTML

### 4. Улучшенная проверка idempotency

**Обновлено:**
- Проверка по URL изображения в figure с `data-blog-inline-image="1"`
- Проверка по basename файла в content_html
- Fallback: проверка URL в любом месте

**Функция:**
```python
def _check_image_already_inserted(content_html: str, image_url: str, basename: str) -> bool:
    # Проверяет наличие URL в figure
    # Проверяет наличие basename в content_html
    # Fallback: проверка URL
```

### 5. Транзакции

**Сохранено:**
- Все изменения в `transaction.atomic()`
- Rollback при ошибке
- Dry-run режим без изменений БД

### 6. Обновлённые тесты

**Добавлено:**
- ✅ `test_command_imports_without_syntax_error` — проверка импорта без SyntaxError
- ✅ `test_move_images_finds_by_base_without_prefix` — поиск по базовому имени без префикса
- ✅ `test_move_images_with_typographic_quotes` — работа с типографскими кавычками
- ✅ `test_move_images_idempotency` — проверка идемпотентности
- ✅ Все тесты проверяют удаление из галереи

## Изменённые файлы

1. **`blog/management/commands/move_images_to_content.py`**
   - Исправлены синтаксические ошибки
   - Переписан поиск изображений по базовым именам
   - Упрощена логика поиска якорей вставки
   - Улучшена проверка idempotency

2. **`tests/test_blog_image_migration.py`**
   - Добавлен тест импорта
   - Обновлены тесты для нового поиска по базовым именам
   - Добавлен тест с типографскими кавычками
   - Исправлено дублирование кода в тестах

## Использование на PROD

```bash
# SSH на сервер
sudo -u carfst -E /home/carfst/app/cursor_work/.venv/bin/python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya --dry-run

# Выполнение
sudo -u carfst -E /home/carfst/app/cursor_work/.venv/bin/python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya

# Проверка результата
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -c "blog-inline-image"
# Ожидаем: 3

curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -n "x3000-8x4-komplektaciya_[234]\.png" | head
# Ожидаем: вхождения есть в inline-figure, а не только в gallery-блоке
```

## Acceptance criteria

✅ **--dry-run показывает 3 найденные картинки и 3 точки вставки**
✅ **Выполнение без --dry-run добавляет 3 `<figure class="blog-inline-image"...>` и убирает эти 3 изображения из галереи**
✅ **`grep -c "blog-inline-image"` возвращает 3**
✅ **Команда компилируется без SyntaxError**
✅ **Команда идемпотентна (повторный запуск безопасен)**
✅ **Тесты проходят**

## Технические детали

### Поиск изображений

**Алгоритм:**
1. Построить список базовых имён: `[slug, slug_without_first_prefix]`
2. Для каждого изображения в галерее:
   - Попробовать каждое базовое имя
   - Проверить паттерн: `^{base}_{n}(?:_[^.]*)?\.(png|jpe?g|webp)$`
3. Если найдено больше одного кандидата на индекс — ошибка
4. Если найдено ровно 3 изображения (по одному на каждый индекс) — продолжить

### Поиск якорей

**Подход:**
- Прямой поиск текста через regex в `content_html`
- Учёт типографских символов через нормализацию в паттернах
- Вставка перед найденным текстом (не в середину тега)

**Примеры паттернов:**
- `Типовые\s+сценарии[^<]*[""«»„"][^<]*стройка` — учитывает типографские кавычки
- `1\)\s*Площадка` — экранированная скобка
- `Чек-лист\s+при[её]мки` — вариация е/ё

### Преимущества нового подхода

1. **Простота**: Не требует сложного парсинга HTML
2. **Устойчивость**: Работает с типографскими символами и вариациями
3. **Надёжность**: Проверка на дубликаты, понятные ошибки
4. **Безопасность**: Транзакции, idempotency, dry-run
