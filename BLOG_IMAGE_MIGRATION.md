# Инструкция по переносу изображений из галереи в тело статьи

## Задача

Перенести 3 изображения из галереи в тело статьи `shacman-x3000-8x4-komplektaciya`:
1. `x3000-8x4-komplektaciya_2.*` - после заголовка "Для каких задач подходит X3000 8x4 (стройка/карьер)", перед "Типовые сценарии..."
2. `x3000-8x4-komplektaciya_3.*` - после абзаца "Короткий ответ... 5 параметров", перед "1) Площадка..."
3. `x3000-8x4-komplektaciya_4.*` - в разделе "Что проверить перед покупкой/выдачей", перед "Чек-лист приёмки..."

### Поддерживаемые форматы файлов

Команда поддерживает гибкий паттерн поиска изображений:
- **Паттерн**: `any_prefix_{2|3|4}(?:_[^.]*)?\.(png|jpg|jpeg|webp)$`
- **Важно**: Префикс имени файла может отличаться от slug статьи. Команда ищет по хвосту `_2`, `_3` или `_4` в имени файла.
- **Примеры допустимых имён**:
  - `x3000-8x4-komplektaciya_2.png` (для статьи с slug `shacman-x3000-8x4-komplektaciya`)
  - `x3000-8x4-komplektaciya_2_720.webp`
  - `anything_3.jpg`
  - `prefix_4.jpeg`
  - `name_2_720.png`
  - И т.д. (регистр не важен)

**Пример на PROD:**
- Slug статьи: `shacman-x3000-8x4-komplektaciya`
- Имена файлов: `x3000-8x4-komplektaciya_2.png`, `x3000-8x4-komplektaciya_3.png`, `x3000-8x4-komplektaciya_4.png`
- Команда найдёт эти файлы, так как они содержат `_2`, `_3`, `_4` перед расширением

## Безопасность

✅ **Idempotent**: безопасно запускать несколько раз (не дублирует изображения)
✅ **Транзакции**: все изменения в одной транзакции (rollback при ошибке)
✅ **Dry-run**: проверка перед выполнением
✅ **Понятные ошибки**: сообщения если якоря/картинки не найдены

## Выполнение

### 1. Проверка (dry-run)

**Локально:**
```bash
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya --dry-run
```

**На PROD:**
```bash
# SSH на сервер
ssh user@carfst.ru

# Перейти в директорию проекта
cd /opt/carfst

# Активировать виртуальное окружение (если используется)
source venv/bin/activate  # или аналогичная команда

# Запустить dry-run
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya --dry-run
```

Команда покажет:
- Какие изображения будут найдены (с именами файлов)
- Где они будут вставлены
- Что будет удалено из галереи
- Если изображения уже в контенте - пропустит их (idempotency)
- Если изображения не найдены - покажет список всех файлов в галерее для диагностики

### 2. Выполнение

**Локально:**
```bash
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya
```

**На PROD:**
```bash
# SSH на сервер
ssh user@carfst.ru
cd /opt/carfst
source venv/bin/activate  # если используется

# Выполнить команду
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya
```

Команда:
- Проверит idempotency (изображения уже в контенте - пропустит)
- Вставит изображения в нужные места в `content_html`
- Удалит эти изображения из галереи (`BlogPostImage`)
- Сохранит изменения в транзакции (rollback при ошибке)

## Проверка результата

### 1. Визуальная проверка

Откройте страницу статьи:
```
https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/
```

Проверьте:
- ✅ Изображения стоят в нужных местах
- ✅ У каждого есть подпись (caption) и alt
- ✅ Внизу нет дублей (галерея не содержит эти 3 картинки)

### 2. Быстрый smoke-тест

**Локально:**
```bash
curl -sL http://localhost:8000/blog/shacman-x3000-8x4-komplektaciya/ | grep -n "x3000-8x4-komplektaciya_"
```

**На PROD:**
```bash
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -n "x3000-8x4-komplektaciya_"
```

Должны быть вхождения только в теле статьи (не в галерее).

### 3. Проверка количества figure элементов

**Локально:**
```bash
curl -sL http://localhost:8000/blog/shacman-x3000-8x4-komplektaciya/ | grep -c 'class="blog-inline-image"'
```

**На PROD:**
```bash
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -c 'class="blog-inline-image"'
```

Должно быть ровно 3 вхождения (по одному на каждое изображение).

### 3. Проверка тестов

```bash
pytest -q
```

Все тесты должны проходить.

## Технические детали

### Формат HTML изображений

Изображения вставляются в формате:
```html
<figure class="blog-inline-image" data-blog-inline-image="1">
    <img src="..." alt="..." loading="lazy" decoding="async" class="img-fluid rounded">
    <figcaption>...</figcaption>
</figure>
```

### Места вставки (точные якоря)

1. **Изображение 2**: 
   - После заголовка `<h2>Для каких задач подходит X3000 8x4 (стройка/карьер)</h2>`
   - Перед параграфом `<p>Типовые сценарии "стройка"</p>`

2. **Изображение 3**: 
   - После параграфа `<p>Короткий ответ для сниппета: ... 5 параметров</p>`
   - Перед нумерованным пунктом `<p>1) Площадка...</p>` или `<h3>1) Площадка...</h3>`

3. **Изображение 4**: 
   - После заголовка `<h2>Что проверить перед покупкой/выдачей: предпродажный чек-лист</h2>`
   - Перед текстом "Чек-лист приёмки" или списком `<ol>/<li>`

### Alt и Caption

- **Image 2**:
  - Alt: "Самосвал SHACMAN X3000 8×4 в условиях стройплощадки и карьера"
  - Caption: "X3000 8×4: типовые условия — стройка и карьер"

- **Image 3**:
  - Alt: "ТЗ на самосвал 8×4 — 5 параметров: площадка, плечо, груз, режим, сезонность"
  - Caption: "ТЗ на самосвал 8×4: что уточнить до подбора комплектации"

- **Image 4**:
  - Alt: "Чек-лист приёмки нового самосвала: спецификация, кузов/подъём, осмотр, комплектность, документы"
  - Caption: "Чек-лист приёмки перед выдачей"

## Тесты

Запуск тестов для проверки команды:

```bash
# Все тесты
pytest tests/test_blog_image_migration.py -v

# Быстрая проверка
pytest tests/test_blog_image_migration.py -q
```

Тесты проверяют:
- ✅ Команда находит пост по slug
- ✅ Команда требует наличие всех 3 изображений
- ✅ Команда находит изображения с разными расширениями (.png, .jpg, .webp)
- ✅ Команда находит изображения с разными суффиксами (_2.png, _2_720.webp)
- ✅ Диагностика показывает список файлов в галерее если не найдены нужные
- ✅ Idempotency (безопасно запускать несколько раз)
- ✅ Изображения вставляются в правильные места
- ✅ Страница рендерится без ошибок после миграции
- ✅ Dry-run не изменяет базу данных
- ✅ content_html содержит ровно 3 figure элемента после миграции

## Откат изменений

Если что-то пошло не так:
1. Восстановить `content_html` из бэкапа базы данных
2. Восстановить удалённые `BlogPostImage` записи через Django admin или бэкап

Команда использует транзакции (`transaction.atomic()`), поэтому при ошибке все изменения откатятся автоматически.

## Диагностика проблем

### Если команда не находит изображения

Команда покажет список всех файлов в галерее статьи:
```
Expected 3 images matching pattern 'any_prefix_{2|3|4}(_*)?.(png|jpg|jpeg|webp)', found 0: []. Missing: [2, 3, 4].

Images found in gallery:
  - other-image.jpg
  - x3000-8x4-komplektaciya_1.png
  - cover.jpg

Expected pattern: any prefix + _{2|3|4} + optional suffix + extension
Pattern examples:
  - x3000-8x4-komplektaciya_2.png
  - anything_2_720.webp
  - prefix_3.jpg
  - name_4.jpeg
```

Проверьте:
- Имена файлов содержат `_2`, `_3` или `_4` перед расширением (префикс может быть любым)
- Файлы загружены в галерею статьи через Django admin
- Расширения файлов поддерживаются (png, jpg, jpeg, webp)

### Если якоря не найдены

Команда покажет точное сообщение об ошибке:
```
Could not find insertion point for image 2.
Looking for heading 'Для каких задач подходит X3000 8x4 (стройка/карьер)'
or paragraph 'Типовые сценарии "стройка"'
```

Проверьте, что в `content_html` присутствуют нужные заголовки/параграфы.

## Примечания

- Команда использует реальные URL изображений из базы данных
- Изображения удаляются из галереи после вставки в контент
- SEO-метаданные и URL статьи не изменяются
- Тесты проекта не должны ломаться
