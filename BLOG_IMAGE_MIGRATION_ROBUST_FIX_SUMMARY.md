# Сводка исправления: устойчивый поиск точек вставки

## Проблема

Команда `move_images_to_content` падала на поиске точек вставки в HTML-контенте статьи на PROD из-за:
- Типографских кавычек `""`, `«»` вместо обычных `"`
- Символа умножения `×` вместо `x`
- HTML-сущностей `&nbsp;`
- Вложенных тегов внутри заголовков/параграфов
- Разных уровней заголовков (h2/h3/h4) и атрибутов (id=...)

## Исправления

### 1. Нормализация текста для сравнения

**Добавлена функция `_normalize_text()`:**
- Приводит к lowercase
- Заменяет типографские кавычки на обычные: `"`, `"`, `«`, `»`, `„`, `"` → `"`
- Заменяет символ умножения: `×`, `×`, `✕`, `✖` → `x`
- Заменяет HTML-сущности: `&nbsp;`, `\xa0`, `\u2009`, `\u202f` → пробел
- Схлопывает множественные пробелы в один

### 2. Извлечение текста из HTML

**Добавлена функция `_extract_text_from_html()`:**
- Удаляет HTML-теги
- Декодирует базовые HTML-сущности (`&nbsp;`, `&amp;`, `&lt;`, `&gt;`)

### 3. Устойчивый поиск HTML-блоков

**Добавлена функция `_find_html_block()`:**
- Ищет HTML-блоки (заголовки/параграфы) по нормализованному тексту
- Корректно обрабатывает вложенные теги через подсчёт открывающих/закрывающих тегов
- Возвращает позицию после закрывающего тега для вставки

**Особенности:**
- Поддерживает любые уровни заголовков (h2, h3, h4)
- Работает с атрибутами тегов (id=..., class=...)
- Корректно обрабатывает вложенные теги (`<h2><strong>текст</strong></h2>`)

### 4. Улучшенная диагностика

**Добавлена функция `_get_diagnostic_info()`:**
- При ошибке показывает похожие заголовки/параграфы (первые 5)
- Выводит контекст вокруг ближайшего совпадения (±200 символов)
- Помогает быстро найти проблему в HTML-контенте

### 5. Обновлённая проверка idempotency

**Улучшена функция `_check_image_already_inserted()`:**
- Проверяет наличие атрибута `data-blog-inline-image="1"` в figure
- Проверяет наличие URL изображения в src атрибуте img внутри figure
- Fallback: проверка URL в любом месте content_html

### 6. Переписанная логика вставки

**Image 2:**
- Ищет заголовок с ключевыми словами: "для каких задач подходит", "x3000", "8x4"
- Вставляет после заголовка, перед параграфом "Типовые сценарии ... стройка"
- Fallback: вставка перед "Типовые сценарии"

**Image 3:**
- Ищет параграф с "5 параметров"
- Вставляет после параграфа, перед "1) Площадка"
- Fallback: поиск заголовка "Главный принцип выбора комплектации"

**Image 4:**
- Ищет заголовок "Что проверить перед покупкой/выдачей"
- Вставляет после заголовка, перед "Чек-лист приёмки"
- Fallback: вставка сразу после заголовка

## Изменённые файлы

1. **`blog/management/commands/move_images_to_content.py`**
   - Добавлены функции нормализации и поиска HTML-блоков
   - Переписана логика вставки для всех 3 изображений
   - Улучшена диагностика при ошибках
   - Обновлена проверка idempotency

2. **`tests/test_blog_image_migration.py`**
   - Добавлен тест `test_move_images_with_typographic_quotes_and_multiply` (типографские кавычки и ×)
   - Добавлен тест `test_move_images_with_nested_tags` (вложенные теги)
   - Обновлены существующие тесты

## Использование на PROD

```bash
# SSH на сервер
sudo -u carfst -E ./.venv/bin/python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya --dry-run

# Выполнение
sudo -u carfst -E ./.venv/bin/python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya

# Проверка результата
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -c "blog-inline-image"
# Ожидаем: 3

curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -n "x3000-8x4-komplektaciya_[234]\.png" | head
# Ожидаем: вхождения есть в inline-figure, а не только в gallery-блоке
```

## Проверки после выполнения

### a) content_html содержит 3 figure элементы

```bash
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -c 'class="blog-inline-image"'
```

Должно быть ровно 3.

### b) Изображения удалены из галереи

```bash
# Проверка через Django shell
python manage.py shell
>>> from blog.models import BlogPost, BlogPostImage
>>> post = BlogPost.objects.get(slug='shacman-x3000-8x4-komplektaciya')
>>> post.images.filter(image__name__contains='_2').exists()  # False
>>> post.images.filter(image__name__contains='_3').exists()  # False
>>> post.images.filter(image__name__contains='_4').exists()  # False
```

### c) Повторный запуск безопасен (idempotency)

```bash
sudo -u carfst -E ./.venv/bin/python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya --dry-run
# Покажет: "All images already in content_html. Nothing to do (idempotent)."
```

## Тесты

```bash
# Запуск всех тестов миграции
pytest tests/test_blog_image_migration.py -v

# Быстрая проверка
pytest tests/test_blog_image_migration.py -q

# Все тесты проекта
pytest -q
```

Все тесты должны проходить.

## Технические детали

### Нормализация текста

**Примеры нормализации:**
- `"стройка"` → `"стройка"`
- `«стройка»` → `"стройка"`
- `8×4` → `8x4`
- `&nbsp;` → пробел
- `Для каких задач подходит X3000 8×4` → `для каких задач подходит x3000 8x4`

### Поиск HTML-блоков

**Алгоритм:**
1. Найти все открывающие теги нужного типа (h2-h4, p)
2. Для каждого открывающего тега найти соответствующий закрывающий тег
3. Учитывать вложенные теги того же типа через подсчёт
4. Извлечь текст из внутреннего содержимого
5. Нормализовать текст и проверить наличие ключевых слов

**Пример:**
```html
<h2 id="tasks">Для каких задач подходит <strong>X3000</strong> <em>8×4</em></h2>
```
- Найдёт заголовок h2
- Извлечёт текст: "Для каких задач подходит X3000 8×4"
- Нормализует: "для каких задач подходит x3000 8x4"
- Проверит наличие ключевых слов: "для каких задач подходит", "x3000", "8x4"

### Преимущества нового подхода

1. **Устойчивость**: Работает с любыми типографскими символами и HTML-форматированием
2. **Гибкость**: Поддерживает разные уровни заголовков и вложенные теги
3. **Диагностика**: Понятные сообщения об ошибках с контекстом
4. **Безопасность**: Сохранены все проверки безопасности (idempotency, транзакции, dry-run)
