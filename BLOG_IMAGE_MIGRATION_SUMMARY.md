# Сводка: Перенос изображений из галереи в тело статьи

## Изменённые файлы

1. **`blog/management/commands/move_images_to_content.py`** (создан/обновлён)
   - Management command для переноса изображений
   - Поддержка idempotency (безопасно запускать несколько раз)
   - Транзакции для безопасности
   - Точные якоря для вставки изображений

2. **`tests/test_blog_image_migration.py`** (создан)
   - Тесты для проверки команды
   - Проверка idempotency
   - Проверка правильности вставки
   - Проверка рендеринга страницы

3. **`BLOG_IMAGE_MIGRATION.md`** (обновлён)
   - Инструкция по использованию команды
   - Описание проверок

## Ключевые особенности

### Безопасность

✅ **Idempotent**: проверка наличия изображений в `content_html` перед вставкой
✅ **Транзакции**: все изменения в `transaction.atomic()`
✅ **Dry-run**: проверка перед выполнением
✅ **Понятные ошибки**: сообщения если якоря/картинки не найдены

### Точные якоря вставки

1. **Image 2** (`_2_720`):
   - После: `<h2>Для каких задач подходит X3000 8x4 (стройка/карьер)</h2>`
   - Перед: `<p>Типовые сценарии "стройка"</p>`

2. **Image 3** (`_3_720`):
   - После: `<p>Короткий ответ для сниппета: ... 5 параметров</p>`
   - Перед: `<p>1) Площадка...</p>` или `<h3>1) Площадка...</h3>`

3. **Image 4** (`_4_720`):
   - После: `<h2>Что проверить перед покупкой/выдачей: предпродажный чек-лист</h2>`
   - Перед: текст "Чек-лист приёмки" или список `<ol>/<li>`

### Формат вставки

```html
<figure class="blog-inline-image" data-blog-inline-image="1">
    <img src="..." alt="..." loading="lazy" decoding="async" class="img-fluid rounded">
    <figcaption>...</figcaption>
</figure>
```

## Использование

```bash
# 1. Проверка (dry-run)
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya --dry-run

# 2. Выполнение
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya

# 3. Повторный запуск безопасен (idempotent)
python manage.py move_images_to_content shacman-x3000-8x4-komplektaciya
```

## Проверки

### 1. Тесты

```bash
pytest tests/test_blog_image_migration.py -v
```

### 2. Визуальная проверка

Откройте: `https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/`

Проверьте:
- ✅ Изображения в нужных местах
- ✅ У каждого есть caption и alt
- ✅ Внизу нет дублей (галерея пустая)

### 3. Smoke-тест

```bash
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -n "x3000-8x4-komplektaciya_"
```

Должны быть вхождения только в теле статьи (не в галерее).

### 4. Проверка рендеринга

```bash
curl -sL https://carfst.ru/blog/shacman-x3000-8x4-komplektaciya/ | grep -c "blog-inline-image"
```

Должно быть 3 вхождения (по одному на каждое изображение).

## Технические детали

### Idempotency

Команда проверяет наличие URL изображения в `content_html` перед вставкой:
- Если изображение уже есть → пропускает вставку
- Если изображения нет → вставляет
- Безопасно запускать несколько раз

### Транзакции

Все изменения выполняются в `transaction.atomic()`:
- Обновление `content_html`
- Удаление изображений из галереи
- При ошибке → автоматический rollback

### Обработка ошибок

- Если пост не найден → `CommandError` с понятным сообщением
- Если изображения не найдены → `CommandError` с указанием каких не хватает
- Если якоря не найдены → `CommandError` с указанием что искалось

## Примечания

- Команда использует реальные URL изображений из базы данных
- Изображения удаляются из галереи только после успешной вставки в контент
- SEO-метаданные и URL статьи не изменяются
- Тесты проекта не должны ломаться
