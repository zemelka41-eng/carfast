"""
Seed SEO content to meet minimum thresholds (600/2500/6) for all indexable pages.

Creates missing records and fills SEO fields with contextual draft content.
By default updates only when content is below thresholds; use --force to overwrite all.

Targets:
- CatalogLandingSEO (/catalog/in-stock/)
- Category (samosvaly, sedelnye-tyagachi, avtobetonosmesiteli)
- Series (shacman)
- SeriesCategorySEO (shacman + categories)
- ShacmanHubSEO (26 hub pages)
- StaticPageSEO (leasing, used, service, parts, payment-delivery)

Usage:
  python manage.py seed_seo_content_full --dry-run   # show what would be done
  python manage.py seed_seo_content_full             # create/update records
  python manage.py seed_seo_content_full --force     # overwrite all content
"""
from django.core.management.base import BaseCommand
from django.utils.html import strip_tags

from catalog.models import (
    CatalogLandingSEO,
    Category,
    Product,
    Series,
    SeriesCategorySEO,
    ShacmanHubSEO,
    StaticPageSEO,
)
from catalog.seo_text import visible_len


# ============================================================================
# Helpers: measure content length (same metric as audit) and FAQ count
# ============================================================================

def _text_length(html: str) -> int:
    """Length of visible text (shared metric with seo_content_audit)."""
    return visible_len(html or "")


def _faq_count(faq_text: str) -> int:
    """Count FAQ items (lines containing '|')."""
    if not faq_text:
        return 0
    return len([line for line in faq_text.strip().split("\n") if "|" in line.strip()])


def _ensure_min_html_text(html: str, min_len: int, filler_blocks: list) -> str:
    """
    Append filler blocks until len(strip_tags(html).strip()) >= min_len.
    Uses same length metric as audit (_text_length / strip_tags).
    """
    current = html or ""
    length = _text_length(current)
    if length >= min_len:
        return current
    idx = 0
    while length < min_len and filler_blocks:
        block = filler_blocks[idx % len(filler_blocks)]
        current = current.rstrip() + "\n\n" + block.strip()
        length = _text_length(current)
        idx += 1
    return current


# Cap length for content comparison (avoid long strings in SequenceMatcher)
_DEDUP_SIG_CAP = 150
# Max number of content signatures to compare against (avoid N^2 when many sections)
_DEDUP_MAX_COMPARE = 12
# Similarity threshold: only remove section if content is nearly identical
_DEDUP_SIMILARITY_THRESHOLD = 0.88


def _deduplicate_html_sections(html_text):
    """
    Remove duplicate sections: only drop when content is very similar (not just same heading).
    Same heading but different meaning -> both sections kept.
    Optimized: normalized text with cap length, compare only with last N sections.
    """
    import re
    from difflib import SequenceMatcher

    if not html_text or not html_text.strip():
        return html_text

    heading_pattern = re.compile(r'(<h([23])>.*?</h\2>)', re.IGNORECASE | re.DOTALL)
    parts = heading_pattern.split(html_text)
    sections = []
    # Keep only last N content signatures to compare (avoid all-vs-all)
    recent_content_sigs = []

    i = 0
    preamble = ""

    while i < len(parts):
        if i == 0 and not heading_pattern.match(parts[i]):
            preamble = parts[i]
            i += 1
            continue

        if i + 2 < len(parts) and heading_pattern.match(parts[i]):
            heading_html = parts[i]
            content = parts[i + 2] if i + 2 < len(parts) else ""
            content_clean = strip_tags(content).strip()
            content_sig = content_clean[:_DEDUP_SIG_CAP].lower()

            # Skip only if content is very similar to a recent section (not by heading alone)
            is_dup_content = False
            if len(content_sig) > 40:  # Only compare non-trivial content
                for existing_sig in recent_content_sigs[-_DEDUP_MAX_COMPARE:]:
                    similarity = SequenceMatcher(None, content_sig, existing_sig[: _DEDUP_SIG_CAP]).ratio()
                    if similarity >= _DEDUP_SIMILARITY_THRESHOLD:
                        is_dup_content = True
                        break

            if is_dup_content:
                i += 3
                continue

            if len(content_sig) > 40:
                recent_content_sigs.append(content_sig)
                if len(recent_content_sigs) > _DEDUP_MAX_COMPARE * 2:
                    recent_content_sigs = recent_content_sigs[-_DEDUP_MAX_COMPARE * 2 :]

            sections.append(heading_html + content)
            i += 3
        else:
            if sections:
                sections[-1] += parts[i]
            else:
                preamble += parts[i]
            i += 1

    return preamble + "".join(sections)


def _remove_empty_sections(html_text):
    """
    Remove sections where heading is followed by no meaningful content.
    A section is empty if content between heading and next heading/end is <20 chars after strip_tags.
    """
    import re
    
    if not html_text or not html_text.strip():
        return html_text
    
    heading_pattern = re.compile(r'<h([23])>(.*?)</h\1>', re.IGNORECASE | re.DOTALL)
    matches = list(heading_pattern.finditer(html_text))
    
    # Build list of sections to keep
    keep_sections = []
    last_end = 0
    
    for i, match in enumerate(matches):
        # Keep everything before this heading
        if match.start() > last_end:
            keep_sections.append(html_text[last_end:match.start()])
        
        heading = match.group(0)
        heading_end = match.end()
        
        # Find content until next heading or end
        if i + 1 < len(matches):
            content_end = matches[i + 1].start()
        else:
            content_end = len(html_text)
        
        content = html_text[heading_end:content_end]
        content_clean = strip_tags(content).strip()
        
        # Keep section only if it has meaningful content
        if len(content_clean) >= 20:
            keep_sections.append(heading + content)
            last_end = content_end
        else:
            # Skip this heading + empty content
            last_end = content_end
    
    # Add any trailing content
    if last_end < len(html_text):
        keep_sections.append(html_text[last_end:])
    
    return "".join(keep_sections)


def _body_filler_blocks(context: str) -> list:
    """Contextual filler blocks (brand/category/line etc) for body catch-up."""
    return [
        f"<h3>Дополнительная информация</h3>\n<p>{context} — надёжная техника с гарантией производителя. Сервисная сеть по всей России, оригинальные запасные части на складе. Оставьте заявку для расчёта стоимости и подбора комплектации.</p>",
        f"<p>Компания CARFAST работает с юридическими лицами и ИП. Доступны лизинг от 10% первоначального взноса, рассрочка, доставка в любой регион. Документальное сопровождение сделки, помощь с регистрацией в ГИБДД.</p>",
        f"<p>Техника {context} соответствует нормам Евро-5, адаптирована под российский климат. Двигатели Weichai, трансмиссия FAST — высокий ресурс и экономичность. Консультация по выбору модели и оформлению заказа — по телефону или на сайте.</p>",
        "<h3>Контакты и заявка</h3>\n<p>Для получения коммерческого предложения оставьте заявку на сайте. Менеджер свяжется в течение 15 минут, подготовит расчёт с учётом региона доставки и способа оплаты. Осмотр техники на складе в Москве по предварительной записи.</p>",
    ]


# Safety margin so that after dedup/remove_empty we still meet min_body
_BODY_SAFETY_MARGIN = 250


def _plain_body_filler_paragraphs(context: str, variant: int) -> list:
    """
    Plain <p> paragraphs (no h2/h3) for final body top-up. Variant index makes text
    differ per product so dedup does not remove them. Used only after dedup/remove_empty.
    """
    templates = [
        f"<p>Кому подходит {context}: предприятия строительной и дорожной отрасли, карьеры, коммунальные службы. Официальный дилер CARFAST подберёт комплектацию и оформит доставку в ваш регион.</p>",
        f"<p>Как выбрать: учитывайте объём кузова, грузоподъёмность и колёсную формулу. Менеджер подготовит сравнение моделей и расчёт стоимости с учётом лизинга или рассрочки.</p>",
        "<p>Условия поставки: доставка автовозом по России, возможен самовывоз со склада в Москве. Документы: ПТС, сертификаты соответствия, гарантийный талон. Сервисное обслуживание в авторизованных центрах по всей стране.</p>",
        f"<p>Документы и сервис: полный пакет для постановки на учёт. Гарантия производителя 24 месяца или 100 000 км. Оригинальные запчасти на складе, консультация по ТО и ремонту.</p>",
        f"<p>Сервис CARFAST: предпродажная подготовка, помощь с логистикой и регистрацией. Для расчёта КП и подбора {context} оставьте заявку — ответим в течение 15 минут.</p>",
    ]
    # Rotate by variant so products get different combinations
    n = len(templates)
    return [templates[(variant + i) % n] for i in range(n)]


# ============================================================================
# Content Templates - designed to meet 600/2500/6 thresholds
# Intro: 650-900 clean chars | Body: 2600-3200 clean chars | FAQ: 6-8 pairs
# ============================================================================

def generate_intro(context: str, entity_type: str) -> str:
    """Generate intro text ~650-700 chars."""
    templates = {
        "catalog_in_stock": """<p>Каталог техники CARFAST — официальный дилер Shacman в России. В наличии на складе самосвалы, седельные тягачи, автобетоносмесители и другая спецтехника.</p>
<p>Вся техника прошла предпродажную подготовку и готова к отгрузке. Предоставляем полный пакет документов: ПТС, ГТД, сертификаты соответствия. Гарантия от производителя — 24 месяца или 100 000 км пробега.</p>
<p>Работаем с юридическими лицами и ИП. Доступны различные варианты финансирования: предоплата, лизинг от 10% первоначального взноса, рассрочка до 12 месяцев. Доставка по всей России — автовозом или своим ходом.</p>
<p>Можете осмотреть технику на складе в Москве перед покупкой. Для иногородних клиентов — видеоосмотр и консультация по характеристикам. Цены фиксируются в коммерческом предложении.</p>
<p>Для получения актуального КП оставьте заявку — менеджер свяжется в течение 15 минут и подготовит расчёт с учётом региона и способа оплаты.</p>""",

        "category": f"""<p>{context} от CARFAST — надёжная техника Shacman для вашего бизнеса. Все модели адаптированы под российские условия эксплуатации и соответствуют нормам Евро-5.</p>
<p>Техника проходит предпродажную проверку и настройку. Комплектация подбирается под конкретные задачи: объём кузова, грузоподъёмность, колёсная формула. Двигатели Weichai WP12/WP13 обеспечивают высокий ресурс до 1 млн км.</p>
<p>Гарантия производителя — 24 месяца или 100 000 км. Сервисное обслуживание в авторизованных центрах по всей России. Оригинальные запасные части на складе, доставка от 1 дня.</p>
<p>Оформление документов, помощь с логистикой, консультация по выбору модели — всё включено в сервис CARFAST. Работаем с лизингом и рассрочкой.</p>
<p>Оставьте заявку для расчёта стоимости и подбора оптимальной комплектации под ваши задачи.</p>""",

        "series": f"""<p>Техника {context} в каталоге CARFAST — полный модельный ряд для строительства, перевозок и спецзадач. Самосвалы, седельные тягачи, автобетоносмесители — все модели в наличии и под заказ.</p>
<p>{context} — один из крупнейших производителей грузовой техники в мире. Заводы оснащены современным оборудованием, качество контролируется по международным стандартам ISO 9001.</p>
<p>В России техника {context} адаптирована под климатические условия: усиленный подогрев топливной системы, морозостойкие материалы, защита от коррозии. Соответствует нормам Евро-5.</p>
<p>CARFAST — официальный дилер с прямыми поставками. Гарантируем подлинность техники, заводскую гарантию и доступ к оригинальным запчастям. Сервисная сеть по всей России.</p>
<p>Для консультации по выбору модели и расчёта стоимости оставьте заявку — менеджер подготовит персональное предложение.</p>""",

        "series_category": f"""<p>{context} — специализированная техника для профессиональных задач. Модели подобраны с учётом российских норм и условий эксплуатации.</p>
<p>Каждая единица техники проходит проверку перед отгрузкой. Документация соответствует требованиям: ПТС, сертификаты соответствия, паспорт техники. Гарантия производителя — 24 месяца.</p>
<p>Предлагаем различные комплектации: базовые и расширенные. Возможна доукомплектация по запросу клиента — спальное место, автономный отопитель, дополнительное оборудование.</p>
<p>Финансирование через лизинг от 10% первоначального взноса или рассрочку. Доставка по всей России. Сервисное сопровождение в авторизованных центрах CARFAST.</p>
<p>Оставьте заявку для расчёта стоимости и подбора оптимальной комплектации под ваши задачи.</p>""",

        "shacman_hub": f"""<p>{context} в каталоге CARFAST. Официальные поставки техники Shacman с заводской гарантией 24 месяца и сервисной поддержкой по всей России.</p>
<p>Техника адаптирована для российских условий: климатический пакет, усиленная рама, надёжные агрегаты Weichai и FAST. Соответствует нормам Евро-5.</p>
<p>Работаем с корпоративными клиентами, автопарками, строительными компаниями. Индивидуальные условия для крупных заказов: скидки, отсрочка платежа, приоритетная поставка.</p>
<p>Доставка по всей России — автовозом или своим ходом. Лизинг от 10% первоначального взноса, срок до 60 месяцев.</p>
<p>Оставьте заявку для расчёта стоимости с учётом доставки и дополнительных опций — менеджер подготовит коммерческое предложение.</p>""",

        "static_leasing": """<p>Лизинг грузовой техники Shacman от CARFAST — выгодные условия для бизнеса. Работаем с ведущими лизинговыми компаниями России: Европлан, ВТБ Лизинг, Сбербанк Лизинг, РЕСО-Лизинг и другими.</p>
<p>Преимущества лизинга: минимальный первоначальный взнос от 10%, срок до 60 месяцев, техника сразу в работе. Платежи относятся на расходы, ускоренная амортизация снижает налоговую нагрузку.</p>
<p>Помогаем с оформлением документов и согласованием условий. Подбираем оптимальную программу под ваш бюджет и задачи. Рассмотрение заявки — от 1 рабочего дня.</p>
<p>Лизинг доступен для юридических лиц и ИП. Требования: срок деятельности от 6 месяцев, положительная кредитная история. Минимальный пакет документов.</p>
<p>Для расчёта лизинговых платежей оставьте заявку — подготовим несколько вариантов на выбор.</p>""",

        "static_used": """<p>Техника с пробегом от CARFAST — проверенные единицы с прозрачной историей. Каждая машина проходит комплексную диагностику перед продажей: двигатель, трансмиссия, тормоза, ходовая часть.</p>
<p>Предоставляем полную информацию: пробег, история обслуживания, состояние узлов. Возможен осмотр на площадке и тест-драйв. Для иногородних — видеоосмотр и подробное описание.</p>
<p>Техника с пробегом — экономичное решение для старта бизнеса или расширения парка. Цены ниже новой техники на 30-50%. Быстрое оформление без ожидания производства.</p>
<p>Гарантия на основные узлы — двигатель, КПП, мосты — от 3 до 6 месяцев. Сервисная поддержка, помощь с регистрацией в ГИБДД. Лизинг и рассрочка доступны.</p>
<p>Оставьте заявку для просмотра актуальных предложений и записи на осмотр.</p>""",

        "static_service": """<p>Сервисное обслуживание техники Shacman в авторизованных центрах CARFAST. Квалифицированные механики прошли обучение на заводе, используем оригинальные запчасти и качественные аналоги.</p>
<p>Выполняем полный спектр работ: регламентное ТО, компьютерная диагностика, ремонт двигателя и топливной аппаратуры, трансмиссии, ходовой части, электрики, кузовные работы.</p>
<p>Используем специализированное оборудование и инструмент. Работы выполняются по технологическим картам производителя. Гарантия на все виды работ — от 6 до 12 месяцев.</p>
<p>Запись на сервис онлайн или по телефону. Есть услуга выездной диагностики — приедем в автопарк или на объект. Стоимость выезда — от 5 000 ₽.</p>
<p>Оставьте заявку для записи на сервис или консультации по техническим вопросам.</p>""",

        "static_parts": """<p>Запасные части Shacman со склада CARFAST. Оригинальные комплектующие Shacman, Weichai, FAST и качественные аналоги для всех моделей техники.</p>
<p>На складе: фильтры воздушные, масляные, топливные; тормозные колодки и диски; элементы подвески; детали двигателя и трансмиссии; электрика. Доставка по России от 1 дня.</p>
<p>Консультируем по подбору запчастей по VIN или модели. Поможем найти редкие позиции под заказ. Гарантия на все товары: оригинал — от производителя, аналоги — от 6 месяцев.</p>
<p>Оптовые цены для сервисов и автопарков. Отсрочка платежа, персональный менеджер, приоритетная обработка заказов.</p>
<p>Для подбора запчастей оставьте заявку с указанием VIN или модели техники.</p>""",

        "static_payment": """<p>Оплата и доставка техники CARFAST — удобные условия для клиентов по всей России. Работаем с юридическими лицами и индивидуальными предпринимателями.</p>
<p>Варианты оплаты: безналичный расчёт, предоплата 100% или частями (50/50), лизинг от партнёрских компаний, рассрочка для постоянных клиентов. Полный пакет документов: договор, счёт, акт приёма-передачи, счёт-фактура.</p>
<p>Доставка автовозом или своим ходом. Рассчитываем стоимость индивидуально с учётом региона, габаритов техники и срочности. Москва и область — бесплатно, регионы — от 30 000 ₽.</p>
<p>Страхование груза включено в стоимость доставки. Покрывает все риски: ДТП, угон, стихийные бедствия. Отслеживание перемещения техники онлайн.</p>
<p>Для расчёта точной стоимости доставки в ваш регион оставьте заявку.</p>""",

        "product": f"""<p>{context} — надёжная техника Shacman от официального дилера CARFAST. Техника прошла предпродажную подготовку и готова к работе.</p>
<p>Все модели адаптированы под российские условия эксплуатации: усиленная рама, климатический пакет, морозостойкие материалы. Соответствует нормам Евро-5.</p>
<p>Двигатели Weichai обеспечивают высокий ресурс и экономичный расход топлива. Трансмиссия FAST — надёжность и плавное переключение.</p>
<p>Гарантия производителя — 24 месяца или 100 000 км пробега. Сервисная поддержка в авторизованных центрах по всей России.</p>
<p>Для получения коммерческого предложения оставьте заявку — менеджер подготовит расчёт с учётом комплектации и доставки.</p>""",
    }
    key = entity_type
    return templates.get(key, templates["category"].format(context=context))


def generate_body(context: str, entity_type: str) -> str:
    """Generate body text ~2600-2800 chars."""
    templates = {
        "catalog_in_stock": f"""<h2>Преимущества покупки техники в наличии</h2>
<p>Техника на складе CARFAST готова к отгрузке — минимум ожидания, максимум выгоды. Вы можете осмотреть технику лично перед покупкой, проверить комплектацию и состояние.</p>

<h3>Что включено в стоимость</h3>
<ul>
<li>Предпродажная подготовка и проверка всех систем</li>
<li>Полный комплект документов: ПТС, ГТД, сертификаты соответствия</li>
<li>Заводская гарантия от производителя</li>
<li>Консультация по эксплуатации и обслуживанию</li>
</ul>

<h3>Условия приобретения</h3>
<p>Работаем с юридическими лицами и индивидуальными предпринимателями. Принимаем различные формы оплаты: безналичный расчёт, предоплата частями, лизинг через партнёрские компании.</p>

<h3>Доставка по России</h3>
<p>Организуем доставку техники в любой регион России. Варианты: автовозом (для техники без регистрации) или своим ходом (при наличии транзитных номеров). Стоимость рассчитывается индивидуально.</p>

<h3>Сервисная поддержка</h3>
<p>После покупки вы получаете доступ к сети авторизованных сервисных центров. Выполняем регламентное ТО, гарантийный и постгарантийный ремонт. Запасные части на складе.</p>

<h3>Как оформить заказ</h3>
<p>Оставьте заявку на сайте или позвоните менеджеру. Подготовим коммерческое предложение с учётом ваших требований: комплектация, регион доставки, способ оплаты. Резервируем технику после согласования условий.</p>

<h3>Регистрация и страхование</h3>
<p>Помогаем с регистрацией в ГИБДД, оформлением полиса ОСАГО и КАСКО. Предоставляем полный комплект документов для постановки на учёт: договор купли-продажи, акт приёма-передачи, ПТС, сертификаты соответствия.</p>

<p>CARFAST — официальный дилер Shacman в России. Прямые поставки с завода, гарантия подлинности техники, полная документальная поддержка сделки. Сервисная сеть по всей стране.</p>""",

        "category": f"""<h2>Техника {context} от CARFAST</h2>
<p>Предлагаем {context.lower()} Shacman различных модификаций. Техника адаптирована для российских условий: усиленная рама, климатический пакет, надёжные агрегаты.</p>

<h3>Особенности конструкции</h3>
<ul>
<li>Высокопрочная рама с антикоррозийной обработкой</li>
<li>Современные двигатели Weichai (WP12, WP13) с нормами Евро-5</li>
<li>Надёжная трансмиссия FAST с алюминиевым картером</li>
<li>Комфортная кабина с кондиционером и автономным отопителем</li>
</ul>

<h3>Комплектации и опции</h3>
<p>Базовая комплектация включает всё необходимое для работы. Дополнительно можно заказать: GPS-мониторинг, тахограф, дополнительные топливные баки, аэродинамический обвес.</p>

<h3>Финансовые условия</h3>
<p>Предлагаем различные варианты приобретения: покупка за полную стоимость, лизинг от 10% первоначального взноса, рассрочка до 12 месяцев для постоянных клиентов.</p>

<h3>Гарантия и сервис</h3>
<p>Заводская гарантия — 24 месяца или 100 000 км пробега. Сервисное обслуживание в авторизованных центрах по всей России. Оригинальные запасные части на складе.</p>

<h3>Доставка и оформление</h3>
<p>Доставляем технику по всей России. Помогаем с регистрацией в ГИБДД, оформлением страховки, получением разрешительных документов для перевозчиков. Срок доставки — от 3 до 14 дней в зависимости от региона.</p>

<h3>Консультация и подбор</h3>
<p>Менеджеры CARFAST помогут подобрать оптимальную модель под ваши задачи: объём перевозок, тип грузов, условия эксплуатации. Учтём специфику вашего бизнеса и предложим лучшее соотношение цены и функциональности.</p>

<p>Для подбора оптимальной модели и расчёта стоимости обратитесь к менеджеру CARFAST. Подготовим персональное предложение с учётом доставки и способа оплаты.</p>""",

        "series": f"""<h2>Техника {context} — надёжность и качество</h2>
<p>{context} — один из крупнейших производителей грузовой техники в мире. Заводы оснащены современным оборудованием, система контроля качества соответствует международным стандартам.</p>

<h3>История бренда</h3>
<p>Компания {context} основана в 1968 году. За более чем 50 лет работы произведено свыше 2 миллионов единиц техники. Продукция поставляется в 90+ стран мира.</p>

<h3>Преимущества техники {context}</h3>
<ul>
<li>Оптимальное соотношение цены и качества</li>
<li>Адаптация под российские климатические условия</li>
<li>Доступность запасных частей</li>
<li>Развитая сервисная сеть в России</li>
<li>Современные двигатели с нормами Евро-5</li>
</ul>

<h3>Модельный ряд</h3>
<p>В каталоге CARFAST представлены: самосвалы с объёмом кузова от 20 до 35 м³, седельные тягачи с различными колёсными формулами, автобетоносмесители объёмом барабана 10-14 м³, специальная техника.</p>

<h3>Почему CARFAST</h3>
<p>Мы являемся официальным дилером {context} в России. Это гарантирует: подлинность техники, заводскую гарантию, доступ к оригинальным запчастям, техническую поддержку от производителя.</p>

<h3>Финансирование и доставка</h3>
<p>Работаем с ведущими лизинговыми компаниями России. Первоначальный взнос от 10%, срок до 60 месяцев. Рассрочка для постоянных клиентов. Доставка по всей России — автовозом или своим ходом. Страхование груза включено.</p>

<p>Оставьте заявку для консультации по выбору модели и расчёта стоимости с доставкой в ваш регион.</p>""",

        "series_category": f"""<h2>{context}</h2>
<p>Специализированная техника для профессиональных задач. Все модели прошли адаптацию для работы в российских условиях.</p>

<h3>Технические характеристики</h3>
<ul>
<li>Современные двигатели Weichai с высоким ресурсом</li>
<li>Надёжная трансмиссия FAST/ZF</li>
<li>Усиленная подвеска для тяжёлых нагрузок</li>
<li>Комфортная кабина с полным оснащением</li>
</ul>

<h3>Варианты комплектации</h3>
<p>Предлагаем базовые и расширенные комплектации. Возможна доукомплектация по запросу: спальное место, автономный отопитель, дополнительное оборудование.</p>

<h3>Финансирование</h3>
<p>Доступны различные программы финансирования: покупка за полную стоимость, лизинг, рассрочка. Работаем с крупнейшими лизинговыми компаниями России.</p>

<h3>Гарантия производителя</h3>
<p>На всю технику действует заводская гарантия. Сервисное обслуживание в авторизованных центрах CARFAST. Оригинальные запасные части на складе.</p>

<h3>Доставка и оформление</h3>
<p>Доставляем технику по всей России. Полное документальное сопровождение: договор, ПТС, сертификаты, страховка.</p>

<p>Для расчёта стоимости и подбора оптимальной комплектации обратитесь к менеджеру.</p>""",

        "shacman_hub": f"""<h2>{context}</h2>
<p>Техника Shacman в каталоге CARFAST — официальные поставки с заводской гарантией и сервисной поддержкой.</p>

<h3>Преимущества Shacman</h3>
<ul>
<li>Проверенная надёжность — более 2 млн произведённых единиц</li>
<li>Адаптация под российский климат</li>
<li>Оптимальная стоимость владения</li>
<li>Доступность запасных частей</li>
</ul>

<h3>Технические особенности</h3>
<p>Современные двигатели Weichai (WP12, WP13) соответствуют нормам Евро-5. Трансмиссия FAST обеспечивает плавное переключение и высокий ресурс. Кабина комплектуется кондиционером и автономным отопителем.</p>

<h3>Сервис и запчасти</h3>
<p>Сеть авторизованных сервисных центров по России. Оригинальные запасные части на складе. Техническая поддержка и консультации.</p>

<h3>Условия покупки</h3>
<p>Работаем с юридическими лицами. Безналичная оплата, лизинг, рассрочка. Доставка по всей России.</p>

<h3>Как заказать</h3>
<p>Оставьте заявку на сайте — менеджер подготовит коммерческое предложение с учётом ваших требований.</p>

<p>CARFAST — официальный дилер Shacman. Гарантируем подлинность техники и качество обслуживания.</p>""",

        "product": f"""<h2>Почему стоит выбрать {context}</h2>
<p>Надёжная техника Shacman от официального дилера CARFAST. Модель прошла предпродажную подготовку и готова к эксплуатации.</p>

<h3>Преимущества модели</h3>
<ul>
<li>Современный двигатель Weichai с нормами Евро-5</li>
<li>Надёжная трансмиссия FAST с высоким ресурсом</li>
<li>Усиленная рама с антикоррозийной обработкой</li>
<li>Комфортная кабина с климат-контролем</li>
</ul>

<h3>Условия приобретения</h3>
<p>Работаем с юридическими лицами и ИП. Доступны различные варианты оплаты: предоплата, лизинг от 10%, рассрочка. Доставка по всей России.</p>

<h3>Гарантия и сервис</h3>
<p>Заводская гарантия — 24 месяца или 100 000 км. Сервисное обслуживание в авторизованных центрах CARFAST. Оригинальные запчасти на складе.</p>

<h3>Финансирование и доставка</h3>
<p>Лизинг от 10% первоначального взноса, срок до 60 месяцев. Доставка автовозом или своим ходом. Помогаем с регистрацией в ГИБДД и оформлением страховки.</p>

<h3>Почему CARFAST</h3>
<p>Официальный дилер Shacman в России. Прямые поставки с завода, гарантия подлинности, профессиональная поддержка. Более 1000 единиц техники поставлено клиентам.</p>

<h3>Как оформить заказ</h3>
<p>Оставьте заявку на сайте или позвоните менеджеру. Подготовим коммерческое предложение с учётом комплектации, региона доставки и способа оплаты.</p>

<p>Для получения актуального КП оставьте заявку — менеджер свяжется в течение 15 минут.</p>""",
    }

    # Static pages
    static_templates = {
        "static_leasing": """<h2>Лизинг грузовой техники Shacman</h2>
<p>Лизинг — оптимальный способ приобретения грузовой техники для бизнеса. Минимальный первоначальный взнос, техника сразу в работе, платежи относятся на расходы.</p>

<h3>Преимущества лизинга</h3>
<ul>
<li>Первоначальный взнос от 10%</li>
<li>Срок договора до 60 месяцев</li>
<li>Налоговая оптимизация — платежи в расходы</li>
<li>Ускоренная амортизация</li>
<li>Техника сразу в эксплуатации</li>
</ul>

<h3>Партнёрские программы</h3>
<p>Работаем с ведущими лизинговыми компаниями: Европлан, Альфа-Лизинг, ВТБ Лизинг, Сбербанк Лизинг, РЕСО-Лизинг и другими. Подберём программу под ваши условия.</p>

<h3>Требования к клиенту</h3>
<p>Лизинг доступен для юридических лиц и ИП. Срок деятельности — от 6 месяцев. Положительная кредитная история. Минимальный пакет документов.</p>

<h3>Процесс оформления</h3>
<p>Подготовим заявку в несколько лизинговых компаний. Вы выбираете лучшее предложение. Срок рассмотрения — от 1 рабочего дня. Оформление договора — в офисе или дистанционно.</p>

<h3>Страхование</h3>
<p>Страхование техники включается в лизинговый платёж. КАСКО защищает от угона, ДТП, стихийных бедствий. Страховка действует по всей России.</p>

<p>Для расчёта лизинговых платежей оставьте заявку — подготовим несколько вариантов на выбор.</p>""",

        "static_used": """<h2>Техника с пробегом от CARFAST</h2>
<p>Грузовая техника Shacman с пробегом — проверенные единицы с прозрачной историей по выгодным ценам.</p>

<h3>Преимущества покупки б/у техники</h3>
<ul>
<li>Цена на 30-50% ниже новой техники</li>
<li>Проверенная надёжность — техника уже показала себя в работе</li>
<li>Быстрое оформление — без ожидания производства</li>
<li>Возможность осмотра и тест-драйва</li>
</ul>

<h3>Что проверяем перед продажей</h3>
<p>Каждая единица техники проходит комплексную диагностику: двигатель, трансмиссия, тормозная система, электрика, ходовая часть. Предоставляем акт осмотра.</p>

<h3>Гарантия</h3>
<p>На технику с пробегом даём гарантию на основные узлы — двигатель, КПП, мосты. Срок — от 3 до 6 месяцев в зависимости от состояния техники.</p>

<h3>Источники техники</h3>
<p>В продажу поступает техника из корпоративных автопарков, лизинговых компаний, trade-in. Вся история эксплуатации документально подтверждена.</p>

<h3>Финансирование</h3>
<p>Технику с пробегом также можно взять в лизинг или рассрочку. Условия — индивидуально, в зависимости от состояния и стоимости.</p>

<p>Для просмотра актуальных предложений и записи на осмотр оставьте заявку.</p>""",

        "static_service": """<h2>Сервисное обслуживание Shacman</h2>
<p>Авторизованный сервис CARFAST — профессиональное обслуживание грузовой техники Shacman с гарантией качества.</p>

<h3>Виды работ</h3>
<ul>
<li>Регламентное ТО по заводским картам</li>
<li>Диагностика всех систем (компьютерная и визуальная)</li>
<li>Ремонт двигателя и топливной аппаратуры</li>
<li>Ремонт трансмиссии и ходовой части</li>
<li>Электрика и электроника</li>
<li>Кузовные работы и покраска</li>
</ul>

<h3>Преимущества нашего сервиса</h3>
<p>Квалифицированные механики прошли обучение на заводе Shacman. Используем оригинальные запасные части и качественные аналоги. Работы выполняются по технологическим картам производителя.</p>

<h3>Оборудование</h3>
<p>Сервис оснащён профессиональным оборудованием: диагностические стенды, грузоподъёмное оборудование, специнструмент. Выполняем работы любой сложности.</p>

<h3>Гарантия на работы</h3>
<p>На все выполненные работы даём гарантию от 6 до 12 месяцев. Используемые запчасти также имеют гарантию производителя.</p>

<h3>Запись и выезд</h3>
<p>Запись на сервис онлайн или по телефону. Есть услуга выездной диагностики — приедем на объект или в автопарк.</p>

<p>Оставьте заявку для записи на сервис или консультации по техническим вопросам.</p>""",

        "static_parts": """<h2>Запасные части Shacman</h2>
<p>Оригинальные запчасти и качественные аналоги для всей линейки техники Shacman. Склад в Москве, доставка по России.</p>

<h3>Ассортимент</h3>
<ul>
<li>Фильтры: воздушные, масляные, топливные, гидравлические</li>
<li>Тормозная система: колодки, диски, суппорты</li>
<li>Подвеска: рессоры, амортизаторы, втулки</li>
<li>Двигатель: поршни, вкладыши, прокладки, форсунки</li>
<li>Трансмиссия: сцепление, синхронизаторы, валы</li>
<li>Электрика: датчики, реле, жгуты, лампы</li>
</ul>

<h3>Оригинал vs аналог</h3>
<p>Предлагаем оригинальные запчасти Shacman/Weichai/FAST и проверенные аналоги. Поможем подобрать оптимальный вариант по соотношению цена-качество.</p>

<h3>Гарантия</h3>
<p>На все товары действует гарантия. Оригинальные запчасти — гарантия производителя. Аналоги — гарантия поставщика от 6 месяцев.</p>

<h3>Доставка</h3>
<p>Отправляем транспортными компаниями по всей России. Сроки — от 1 дня (Москва и область) до 7-10 дней (удалённые регионы). Возможен самовывоз со склада.</p>

<h3>Для автопарков</h3>
<p>Специальные условия для корпоративных клиентов: оптовые цены, отсрочка платежа, персональный менеджер, приоритетная обработка заказов.</p>

<p>Для подбора запчастей и расчёта стоимости оставьте заявку с указанием VIN или модели техники.</p>""",

        "static_payment": """<h2>Оплата и доставка техники</h2>
<p>Удобные условия оплаты и доставки грузовой техники по всей России от официального дилера CARFAST.</p>

<h3>Способы оплаты</h3>
<ul>
<li>Безналичный расчёт для юридических лиц и ИП</li>
<li>Предоплата 100% или частями (50/50)</li>
<li>Лизинг от партнёрских компаний</li>
<li>Рассрочка для постоянных клиентов</li>
</ul>

<h3>Документы</h3>
<p>Предоставляем полный пакет документов: договор купли-продажи, счёт на оплату, акт приёма-передачи, счёт-фактура, ПТС, сертификаты соответствия.</p>

<h3>Доставка</h3>
<p>Организуем доставку техники в любой регион России. Варианты транспортировки:</p>
<ul>
<li>Автовоз — для техники без регистрации</li>
<li>Своим ходом — при наличии транзитных номеров</li>
<li>Железнодорожный транспорт — для удалённых регионов</li>
</ul>

<h3>Стоимость доставки</h3>
<p>Рассчитывается индивидуально с учётом расстояния, габаритов техники, срочности. Ориентировочно: Москва и область — бесплатно, Центральный ФО — от 30 000 ₽, Сибирь и Дальний Восток — от 100 000 ₽.</p>

<h3>Страхование</h3>
<p>Техника страхуется на время доставки. Стоимость страховки включена в цену транспортировки. Полис покрывает все риски: ДТП, угон, стихийные бедствия.</p>

<p>Для расчёта точной стоимости доставки в ваш регион оставьте заявку.</p>""",
    }

    key = entity_type
    if key in static_templates:
        return static_templates[key]
    return templates.get(key, templates["category"].format(context=context))


def generate_faq(entity_type: str) -> str:
    """Generate FAQ with 6+ items (question|answer per line)."""
    templates = {
        "catalog_in_stock": """Какие сроки отгрузки техники в наличии?|Техника на складе готова к отгрузке в течение 1-3 рабочих дней после оплаты или подписания лизингового договора.
Можно ли осмотреть технику перед покупкой?|Да, организуем осмотр на складе в Москве по предварительной договорённости. Возможен видеоосмотр для иногородних клиентов.
Какие документы идут с техникой?|ПТС (паспорт транспортного средства), ГТД (грузовая таможенная декларация), сертификаты соответствия, руководство по эксплуатации.
Какая гарантия на технику?|Заводская гарантия — 24 месяца или 100 000 км пробега (что наступит раньше). Гарантийное обслуживание в авторизованных сервисных центрах.
Как оформить лизинг?|Оставьте заявку — подготовим документы для нескольких лизинговых компаний. Срок рассмотрения — от 1 рабочего дня.
Доставляете ли в регионы?|Да, доставляем по всей России. Автовозом или своим ходом в зависимости от наличия регистрации. Стоимость рассчитываем индивидуально.
Есть ли скидки на несколько единиц?|Да, при покупке от 3 единиц предоставляем корпоративную скидку. Размер обсуждается индивидуально.
Работаете ли с бюджетными организациями?|Да, работаем по 44-ФЗ и 223-ФЗ. Участвуем в тендерах, предоставляем полный пакет документов.""",

        "category": """Какие модели {category} есть в наличии?|Актуальный ассортимент представлен на сайте. Для уточнения наличия конкретной модели оставьте заявку — менеджер перезвонит.
Чем отличаются комплектации?|Базовая включает стандартное оснащение. Расширенная — дополнительные опции: спальник, автономный отопитель, навигация. Подберём под ваши задачи.
Какая грузоподъёмность техники?|Зависит от модели и комплектации. Диапазон — от 20 до 50 тонн полной массы. Уточняйте при заказе.
Есть ли техника с правым рулём?|Нет, вся техника Shacman производится с левым расположением руля для российского рынка.
Какой расход топлива?|Средний расход — 35-45 л/100 км в зависимости от модели, нагрузки и условий эксплуатации. Точные данные — в характеристиках конкретной модели.
Адаптирована ли техника для зимы?|Да, все модели комплектуются климатическим пакетом: подогрев топливной системы, морозостойкие материалы, предпусковой подогреватель.
Какие двигатели устанавливаются?|Weichai WP12 (430 л.с.) и WP13 (480 л.с.). Оба соответствуют нормам Евро-5. Ресурс — до 1 млн км при правильном обслуживании.""",

        "series": """Какие модели {series} представлены в каталоге?|Самосвалы, седельные тягачи, автобетоносмесители, специальная техника. Полный ассортимент — на сайте.
{series} — это китайская техника?|Да, Shacman — один из крупнейших китайских производителей. Заводы оснащены оборудованием мирового уровня, качество контролируется по международным стандартам.
Надёжна ли техника {series}?|{series} выпускает технику с 1968 года. За это время произведено более 2 млн единиц. Техника эксплуатируется в 90+ странах мира.
Есть ли запчасти на {series} в России?|Да, оригинальные запчасти и качественные аналоги есть на складе. Доставка по России от 1 дня.
Какой межсервисный интервал?|Регламентное ТО — каждые 10 000-15 000 км в зависимости от условий эксплуатации. Точные интервалы — в сервисной книжке.
Где можно пройти ТО?|В авторизованных сервисных центрах CARFAST и партнёров. Сеть охватывает основные регионы России.
Какая гарантия на технику {series}?|Заводская гарантия — 24 месяца или 100 000 км. Распространяется на все узлы и агрегаты.""",

        "series_category": """Какие варианты техники {series} {category} есть?|Несколько модификаций с разными характеристиками. Подберём оптимальный вариант под ваши задачи — оставьте заявку.
Чем отличаются модели друг от друга?|Колёсная формула, мощность двигателя, грузоподъёмность, комплектация кабины. Детали — в характеристиках каждой модели.
Можно ли заказать технику под свои требования?|Да, возможен заказ с завода с нужной комплектацией. Срок — от 45 дней.
Какие условия оплаты?|Безналичный расчёт, предоплата, лизинг, рассрочка. Выберем удобный вариант.
Есть ли скидки?|При покупке нескольких единиц — корпоративная скидка. Размер обсуждается индивидуально.
Какой срок доставки?|Техника в наличии — 1-3 дня. Под заказ — от 45 дней. Доставка по России — от 3 до 14 дней в зависимости от региона.""",

        "shacman_hub": """Какие модели Shacman есть в наличии?|Актуальный ассортимент — на сайте. Для уточнения наличия конкретной модели оставьте заявку.
Shacman — это надёжная техника?|Да, Shacman производит технику более 50 лет. Заводы сертифицированы по ISO 9001. Техника эксплуатируется в 90+ странах.
Какая гарантия?|Заводская гарантия — 24 месяца или 100 000 км. Гарантийное обслуживание — в авторизованных сервисных центрах.
Есть ли запчасти?|Да, оригинальные запчасти и аналоги на складе. Доставка по России от 1 дня.
Как оформить покупку?|Оставьте заявку — менеджер подготовит коммерческое предложение. Далее — договор, оплата, отгрузка.
Работаете ли с регионами?|Да, доставляем технику по всей России. Стоимость рассчитываем индивидуально.
Можно ли взять в лизинг?|Да, работаем с ведущими лизинговыми компаниями. Первоначальный взнос от 10%, срок до 60 месяцев.""",

        "static_leasing": """Какой минимальный первоначальный взнос?|От 10% стоимости техники. Точный размер зависит от программы лизинговой компании и финансового состояния клиента.
На какой срок можно взять лизинг?|От 12 до 60 месяцев. Оптимальный срок — 36-48 месяцев, балансирует размер платежа и переплату.
Какие документы нужны для лизинга?|Заявка, учредительные документы, финансовая отчётность за последний год. Точный список — у менеджера.
Сколько рассматривается заявка?|От 1 рабочего дня в экспресс-режиме, до 5 дней — стандартное рассмотрение.
Можно ли досрочно погасить лизинг?|Да, большинство программ позволяют досрочное погашение. Условия — в договоре.
Кто является собственником техники?|До полного погашения — лизинговая компания. После выкупа — переходит в собственность клиента.
Включена ли страховка в платёж?|Обычно да, КАСКО включается в лизинговый платёж. Можно оформить отдельно для экономии.""",

        "static_used": """Какая техника с пробегом есть в продаже?|Ассортимент меняется. Актуальные предложения — по запросу. Оставьте заявку, вышлем список.
Что проверяете перед продажей?|Комплексная диагностика: двигатель, трансмиссия, тормоза, ходовая, электрика. Предоставляем акт осмотра.
Есть ли гарантия на б/у технику?|Да, даём гарантию на основные узлы от 3 до 6 месяцев в зависимости от состояния.
Можно ли осмотреть технику?|Да, организуем осмотр на площадке. Для иногородних — видеоосмотр.
Откуда поступает техника?|Корпоративные автопарки, лизинговые компании, trade-in. История эксплуатации документально подтверждена.
Можно ли взять б/у технику в лизинг?|Да, некоторые лизинговые компании финансируют технику с пробегом. Условия индивидуальные.
Какие документы идут с техникой?|ПТС, договор купли-продажи, акт приёма-передачи. При необходимости — сервисная история.""",

        "static_service": """Какие виды работ выполняете?|Регламентное ТО, диагностика, ремонт двигателя и трансмиссии, ходовая часть, электрика, кузовные работы.
Сколько стоит ТО?|Зависит от модели и регламента. Ориентировочно: ТО-1 — от 15 000 ₽, ТО-2 — от 25 000 ₽. Точная стоимость — по запросу.
Есть ли выездной сервис?|Да, выезжаем на диагностику в автопарки и на объекты. Стоимость выезда — от 5 000 ₽.
Какая гарантия на работы?|От 6 до 12 месяцев в зависимости от вида работ. На запчасти — гарантия производителя.
Сколько занимает ремонт?|ТО — 1 день. Текущий ремонт — 2-5 дней. Капитальный — от 10 дней. Сроки уточняем после диагностики.
Используете оригинальные запчасти?|Да, оригинальные и проверенные аналоги. Клиент выбирает оптимальный вариант.
Как записаться на сервис?|Оставьте заявку на сайте или позвоните. Согласуем дату и время.""",

        "static_parts": """Какие запчасти есть в наличии?|Фильтры, тормозные колодки, элементы подвески, детали двигателя, электрика. Полный каталог — по запросу.
Это оригинальные запчасти?|Есть оригинальные (Shacman, Weichai, FAST) и качественные аналоги. Поможем подобрать оптимальный вариант.
Как подобрать нужную запчасть?|Укажите VIN техники или модель и год выпуска. Менеджер подберёт и подтвердит совместимость.
Какая гарантия?|На оригинал — гарантия производителя. На аналоги — от 6 месяцев. Сохраняйте чек.
Как быстро доставите?|Москва — 1 день. Регионы — 3-10 дней в зависимости от расстояния.
Есть ли скидки для автопарков?|Да, оптовые цены, отсрочка платежа, персональный менеджер. Обсудим условия при заказе.
Можно ли вернуть запчасть?|Да, в течение 14 дней если товар не подошёл и сохранён товарный вид. Возврат за счёт покупателя.""",

        "product": """Какая гарантия на эту модель?|Заводская гарантия 24 месяца или 100 000 км пробега (что наступит раньше). Гарантия распространяется на все узлы и агрегаты.
Можно ли изменить комплектацию?|Да, подберём комплектацию под ваши задачи. Возможны доукомплектация, установка дополнительного оборудования.
Какие сроки поставки?|Техника в наличии — 1-3 рабочих дня. Под заказ — от 30 дней. Точные сроки зависят от модификации.
Доставляете в регионы?|Да, доставка по всей России. Автовозом или своим ходом. Стоимость рассчитывается индивидуально.
Возможен ли лизинг?|Да, работаем с ведущими лизинговыми компаниями. Первоначальный взнос от 10%, срок до 60 месяцев.
Как оформить заявку?|Оставьте заявку на сайте или позвоните менеджеру. Подготовим КП в течение 15 минут.
Где находится сервис?|Авторизованные сервисные центры по всей России. Регламентное ТО, гарантийный и постгарантийный ремонт.
Есть ли запчасти в наличии?|Да, оригинальные запчасти Shacman на складе. Доставка по России от 1 дня.""",

        "static_payment": """Какие способы оплаты принимаете?|Безналичный расчёт для юрлиц, предоплата 100% или частями, лизинг, рассрочка.
Какие документы предоставляете?|Договор, счёт, акт приёма-передачи, счёт-фактура, ПТС, сертификаты.
Сколько стоит доставка?|Рассчитывается индивидуально. Москва — бесплатно. Регионы — от 30 000 ₽.
Как долго идёт доставка?|Москва и область — 1-3 дня. Регионы — от 3 до 14 дней.
Страхуете ли технику при доставке?|Да, страховка включена в стоимость доставки. Покрывает все риски.
Можно ли отследить доставку?|Да, предоставляем номер для отслеживания. Информируем о статусе.
Что если техника повреждена при доставке?|Оформляем акт, страховая компания возмещает ущерб. Мы сопровождаем весь процесс.""",
    }

    key = entity_type
    return templates.get(key, templates["category"])


def generate_meta_title(context: str, entity_type: str) -> str:
    """Generate meta title for SEO."""
    templates = {
        "catalog_in_stock": "Техника Shacman в наличии — купить грузовики со склада | CARFAST",
        "static_leasing": "Лизинг грузовой техники Shacman — выгодные условия | CARFAST",
        "static_used": "Техника Shacman с пробегом — б/у грузовики | CARFAST",
        "static_service": "Сервис Shacman — ТО и ремонт грузовой техники | CARFAST",
        "static_parts": "Запчасти Shacman — оригинал и аналоги | CARFAST",
        "static_payment": "Оплата и доставка техники Shacman | CARFAST",
    }
    if entity_type in templates:
        return templates[entity_type]
    return f"{context} — купить у официального дилера | CARFAST"


class Command(BaseCommand):
    help = "Seed SEO content to meet minimum thresholds (600/2500/6) for all indexable pages."

    def add_arguments(self, parser):
        parser.add_argument(
            "--dry-run",
            action="store_true",
            help="Only print what would be created/updated, do not save.",
        )
        parser.add_argument(
            "--min-intro",
            type=int,
            default=600,
            help="Minimum intro length in chars after strip_tags (default: 600)",
        )
        parser.add_argument(
            "--min-body",
            type=int,
            default=2500,
            help="Minimum body length in chars after strip_tags (default: 2500)",
        )
        parser.add_argument(
            "--min-faq",
            type=int,
            default=6,
            help="Minimum FAQ count (default: 6)",
        )
        parser.add_argument(
            "--force",
            action="store_true",
            help="Overwrite all content regardless of current length.",
        )
        parser.add_argument(
            "--include-products",
            action="store_true",
            help="Include individual products in seeding (may be slow).",
        )

    def handle(self, *args, **options):
        dry_run = options["dry_run"]
        min_intro = options["min_intro"]
        min_body = options["min_body"]
        min_faq = options["min_faq"]
        force = options["force"]

        if dry_run:
            self.stdout.write("DRY-RUN: no changes will be saved.\n")

        created = 0
        updated = 0

        # 1. CatalogLandingSEO
        c, u = self._seed_catalog_landing(
            dry_run, min_intro, min_body, min_faq, force
        )
        created += c
        updated += u

        # 2. StaticPageSEO
        c, u = self._seed_static_pages(
            dry_run, min_intro, min_body, min_faq, force
        )
        created += c
        updated += u

        # 3. Categories
        c, u = self._seed_categories(
            dry_run, min_intro, min_body, min_faq, force
        )
        created += c
        updated += u

        # 4. Series (shacman)
        c, u = self._seed_series(
            dry_run, min_intro, min_body, min_faq, force
        )
        created += c
        updated += u

        # 5. SeriesCategorySEO
        c, u = self._seed_series_category(
            dry_run, min_intro, min_body, min_faq, force
        )
        created += c
        updated += u

        # 6. ShacmanHubSEO
        c, u = self._seed_shacman_hubs(
            dry_run, min_intro, min_body, min_faq, force
        )
        created += c
        updated += u

        # 7. Products (optional, if --include-products)
        include_products = options.get("include_products", False)
        if include_products:
            c, u = self._seed_products(
                dry_run, min_intro, min_body, min_faq, force
            )
            created += c
            updated += u

        self.stdout.write(
            self.style.SUCCESS(f"\nDone. Created: {created}, Updated: {updated}")
        )

    def _seed_catalog_landing(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        created, updated = 0, 0
        landing_key = CatalogLandingSEO.LandingKey.CATALOG_IN_STOCK

        obj, was_created = CatalogLandingSEO.objects.get_or_create(
            landing_key=landing_key,
            defaults={
                "meta_title": "",
                "meta_description": "",
                "seo_intro_html": "",
                "seo_body_html": "",
                "faq_items": "",
            },
        )
        if was_created:
            created += 1
            self.stdout.write(f"  Created CatalogLandingSEO: {landing_key}")

        changed = False
        if force or not (obj.meta_title or "").strip():
            obj.meta_title = generate_meta_title("", "catalog_in_stock")
            changed = True
        if force or _text_length(obj.seo_intro_html or "") < min_intro:
            obj.seo_intro_html = generate_intro("", "catalog_in_stock")
            changed = True
        if force or _text_length(obj.seo_body_html or "") < min_body:
            obj.seo_body_html = generate_body("", "catalog_in_stock")
            obj.seo_body_html = _ensure_min_html_text(
                obj.seo_body_html, min_body, _body_filler_blocks("CARFAST / Shacman")
            )
            changed = True
        if force or _faq_count(obj.faq_items or "") < min_faq:
            obj.faq_items = generate_faq("catalog_in_stock")
            changed = True

        if changed:
            updated += 1
            if not dry_run:
                obj.save()
            self.stdout.write(f"  Updated CatalogLandingSEO: {landing_key}")

        return created, updated

    def _seed_static_pages(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        created, updated = 0, 0
        slugs = ["leasing", "used", "service", "parts", "payment-delivery"]

        for slug in slugs:
            entity_type = f"static_{slug.replace('-', '_')}"
            if slug == "payment-delivery":
                entity_type = "static_payment"

            obj, was_created = StaticPageSEO.objects.get_or_create(
                slug=slug,
                defaults={
                    "meta_title": "",
                    "meta_description": "",
                    "seo_intro_html": "",
                    "seo_body_html": "",
                    "faq_items": "",
                },
            )
            if was_created:
                created += 1
                self.stdout.write(f"  Created StaticPageSEO: {slug}")

            changed = False
            if force or not (obj.meta_title or "").strip():
                obj.meta_title = generate_meta_title(slug.title(), entity_type)
                changed = True
            if force or _text_length(obj.seo_intro_html or "") < min_intro:
                obj.seo_intro_html = generate_intro(slug, entity_type)
                changed = True
            if force or _text_length(obj.seo_body_html or "") < min_body:
                obj.seo_body_html = generate_body(slug, entity_type)
                obj.seo_body_html = _ensure_min_html_text(
                    obj.seo_body_html, min_body, _body_filler_blocks(slug.title())
                )
                changed = True
            if force or _faq_count(obj.faq_items or "") < min_faq:
                obj.faq_items = generate_faq(entity_type)
                changed = True

            if changed:
                updated += 1
                if not dry_run:
                    obj.save()
                self.stdout.write(f"  Updated StaticPageSEO: {slug}")

        return created, updated

    def _seed_categories(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        created, updated = 0, 0
        category_data = [
            ("samosvaly", "Самосвалы Shacman"),
            ("sedelnye-tyagachi", "Седельные тягачи Shacman"),
            ("avtobetonosmesiteli", "Автобетоносмесители Shacman"),
        ]

        for slug, name in category_data:
            cat = Category.objects.filter(slug=slug).first()
            if not cat:
                if dry_run:
                    self.stdout.write(f"  [dry-run] Would create Category: {slug}")
                    continue
                cat = Category.objects.create(name=name, slug=slug)
                created += 1
                self.stdout.write(f"  Created Category: {slug}")

            changed = False
            if force or _text_length(getattr(cat, "seo_intro_html", None) or "") < min_intro:
                cat.seo_intro_html = generate_intro(name, "category")
                changed = True
            if force or _text_length(getattr(cat, "seo_body_html", None) or "") < min_body:
                cat.seo_body_html = generate_body(name, "category")
                cat.seo_body_html = _ensure_min_html_text(
                    cat.seo_body_html, min_body, _body_filler_blocks(name)
                )
                changed = True
            if force or _faq_count(getattr(cat, "seo_faq", None) or "") < min_faq:
                cat.seo_faq = generate_faq("category").replace("{category}", name)
                changed = True

            if changed:
                updated += 1
                if not dry_run:
                    cat.save()
                self.stdout.write(f"  Updated Category: {slug}")

        return created, updated

    def _seed_series(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        created, updated = 0, 0
        series = Series.objects.filter(slug__iexact="shacman").first()

        if not series:
            if dry_run:
                self.stdout.write("  [dry-run] Would create Series: shacman")
                return 0, 0
            series = Series.objects.create(
                name="SHACMAN",
                slug="shacman",
                description_ru="",
                description_en="",
                history="",
            )
            created += 1
            self.stdout.write("  Created Series: shacman")

        changed = False
        if force or _text_length(getattr(series, "seo_intro_html", None) or "") < min_intro:
            series.seo_intro_html = generate_intro("SHACMAN", "series")
            changed = True
        if force or _text_length(getattr(series, "seo_body_html", None) or "") < min_body:
            series.seo_body_html = generate_body("SHACMAN", "series")
            series.seo_body_html = _ensure_min_html_text(
                series.seo_body_html, min_body, _body_filler_blocks("SHACMAN")
            )
            changed = True
        if force or _faq_count(getattr(series, "seo_faq", None) or "") < min_faq:
            series.seo_faq = generate_faq("series").replace("{series}", "SHACMAN")
            changed = True

        if changed:
            updated += 1
            if not dry_run:
                series.save()
            self.stdout.write("  Updated Series: shacman")

        return created, updated

    def _seed_series_category(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        created, updated = 0, 0
        series = Series.objects.filter(slug__iexact="shacman").first()
        if not series:
            return 0, 0

        category_slugs = ["samosvaly", "sedelnye-tyagachi", "avtobetonosmesiteli"]
        for slug in category_slugs:
            cat = Category.objects.filter(slug=slug).first()
            if not cat:
                continue

            obj, was_created = SeriesCategorySEO.objects.get_or_create(
                series=series,
                category=cat,
                defaults={},
            )
            if was_created:
                created += 1
                self.stdout.write(f"  Created SeriesCategorySEO: shacman + {slug}")

            context = f"SHACMAN {cat.name}"
            changed = False
            if force or _text_length(getattr(obj, "seo_intro_html", None) or "") < min_intro:
                obj.seo_intro_html = generate_intro(context, "series_category")
                changed = True
            if force or _text_length(getattr(obj, "seo_body_html", None) or "") < min_body:
                obj.seo_body_html = generate_body(context, "series_category")
                obj.seo_body_html = _ensure_min_html_text(
                    obj.seo_body_html, min_body, _body_filler_blocks(context)
                )
                changed = True
            if force or _faq_count(getattr(obj, "seo_faq", None) or "") < min_faq:
                obj.seo_faq = generate_faq("series_category").replace(
                    "{series}", "SHACMAN"
                ).replace("{category}", cat.name)
                changed = True

            if changed:
                updated += 1
                if not dry_run:
                    obj.save()
                self.stdout.write(f"  Updated SeriesCategorySEO: shacman + {slug}")

        return created, updated

    def _seed_shacman_hubs(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        created, updated = 0, 0

        # Get categories for hub types that need them
        category_slugs = ["samosvaly", "sedelnye-tyagachi", "avtobetonosmesiteli"]
        categories = {
            cat.slug: cat for cat in Category.objects.filter(slug__in=category_slugs)
        }

        # Define all hub configurations
        hub_configs = []

        # Main hubs (no category, no facet)
        for hub_type in [ShacmanHubSEO.HubType.MAIN, ShacmanHubSEO.HubType.IN_STOCK]:
            hub_configs.append(
                {"hub_type": hub_type, "category": None, "facet_key": None}
            )

        # Category hubs
        for slug in category_slugs:
            cat = categories.get(slug)
            if cat:
                for hub_type in [
                    ShacmanHubSEO.HubType.CATEGORY,
                    ShacmanHubSEO.HubType.CATEGORY_IN_STOCK,
                ]:
                    hub_configs.append(
                        {"hub_type": hub_type, "category": cat, "facet_key": None}
                    )

        # Formula hubs
        for formula in ["4x2", "6x4", "8x4"]:
            for hub_type in [
                ShacmanHubSEO.HubType.FORMULA,
                ShacmanHubSEO.HubType.FORMULA_IN_STOCK,
            ]:
                hub_configs.append(
                    {"hub_type": hub_type, "category": None, "facet_key": formula}
                )

        # Engine hubs
        for engine in ["wp12", "wp13"]:
            for hub_type in [
                ShacmanHubSEO.HubType.ENGINE,
                ShacmanHubSEO.HubType.ENGINE_IN_STOCK,
            ]:
                hub_configs.append(
                    {"hub_type": hub_type, "category": None, "facet_key": engine}
                )

        # Line hubs
        for line in ["x3000", "x6000", "x5000", "l3000"]:
            for hub_type in [
                ShacmanHubSEO.HubType.LINE,
                ShacmanHubSEO.HubType.LINE_IN_STOCK,
            ]:
                hub_configs.append(
                    {"hub_type": hub_type, "category": None, "facet_key": line}
                )

        # Process each hub
        for config in hub_configs:
            lookup = {"hub_type": config["hub_type"]}
            if config["category"]:
                lookup["category"] = config["category"]
            else:
                lookup["category__isnull"] = True
            if config["facet_key"]:
                lookup["facet_key"] = config["facet_key"]

            # Try to find existing or create
            try:
                obj = ShacmanHubSEO.objects.filter(**lookup).first()
                was_created = False
                if not obj:
                    create_data = {
                        "hub_type": config["hub_type"],
                        "category": config["category"],
                        "facet_key": config["facet_key"] or "",
                        "meta_title": "",
                        "meta_description": "",
                    }
                    if dry_run:
                        self.stdout.write(
                            f"  [dry-run] Would create ShacmanHubSEO: {config}"
                        )
                        continue
                    obj = ShacmanHubSEO.objects.create(**create_data)
                    was_created = True
                    created += 1
                    self.stdout.write(f"  Created ShacmanHubSEO: {config['hub_type']}")
            except Exception as e:
                self.stdout.write(f"  Error with hub {config}: {e}")
                continue

            # Build context string
            hub_type_display = obj.get_hub_type_display() if hasattr(obj, 'get_hub_type_display') else str(config["hub_type"])
            context = f"Shacman {hub_type_display}"
            if config["category"]:
                context = f"Shacman {config['category'].name}"
            if config["facet_key"]:
                context = f"Shacman {config['facet_key'].upper()}"

            changed = False
            if force or not (getattr(obj, "meta_title", None) or "").strip():
                obj.meta_title = generate_meta_title(context, "shacman_hub")
                changed = True
            if force or _text_length(getattr(obj, "seo_intro_html", None) or "") < min_intro:
                obj.seo_intro_html = generate_intro(context, "shacman_hub")
                changed = True
            if force or _text_length(getattr(obj, "seo_body_html", None) or "") < min_body:
                obj.seo_body_html = generate_body(context, "shacman_hub")
                obj.seo_body_html = _ensure_min_html_text(
                    obj.seo_body_html, min_body, _body_filler_blocks(context)
                )
                changed = True
            if force or _faq_count(getattr(obj, "faq", None) or "") < min_faq:
                obj.faq = generate_faq("shacman_hub")
                changed = True

            if changed:
                updated += 1
                if not dry_run:
                    obj.save()
                self.stdout.write(f"  Updated ShacmanHubSEO: {config['hub_type']}")

        return created, updated

    def _seed_products(
        self, dry_run: bool, min_intro: int, min_body: int, min_faq: int, force: bool
    ) -> tuple:
        """
        Seed SEO fields for products (seo_title_override, seo_description_override,
        seo_text_override, seo_faq_override).
        """
        self.stdout.write("Seeding Product SEO...")
        created, updated = 0, 0

        products = Product.objects.public().select_related("series", "category", "model_variant")
        for product in products:
            # Build context string for templates
            parts = []
            if product.model_name_ru:
                parts.append(product.model_name_ru)
            elif product.series:
                parts.append(product.series.name)
            if product.category:
                parts.append(product.category.name)
            if product.wheel_formula:
                parts.append(product.wheel_formula)
            context = " ".join(parts) if parts else "Техника Shacman"

            changed = False

            # Meta title (seo_title_override)
            if force or not (product.seo_title_override or "").strip():
                product.seo_title_override = f"{context} — купить у официального дилера | CARFAST"
                changed = True

            # Intro (seo_description_override)
            if force or _text_length(product.seo_description_override or "") < min_intro:
                product.seo_description_override = generate_intro(context, "product")
                changed = True

            # Body (seo_text_override): order so final length by visible_len >= min_body after dedup/cleanup
            if force or visible_len(product.seo_text_override or "") < min_body:
                product.seo_text_override = generate_body(context, "product")
                # 1) dedup + remove_empty
                product.seo_text_override = _remove_empty_sections(product.seo_text_override)
                product.seo_text_override = _deduplicate_html_sections(product.seo_text_override)
                # 2) ensure min with safety margin, then dedup/remove_empty again
                product.seo_text_override = _ensure_min_html_text(
                    product.seo_text_override,
                    min_body + _BODY_SAFETY_MARGIN,
                    _body_filler_blocks(context),
                )
                product.seo_text_override = _remove_empty_sections(product.seo_text_override)
                product.seo_text_override = _deduplicate_html_sections(product.seo_text_override)
                # 3) if still short: append plain <p> filler (no dedup after, so filler is not removed)
                variant = hash(product.slug or str(product.pk)) % 100
                paras = _plain_body_filler_paragraphs(context, variant)
                idx = 0
                while visible_len(product.seo_text_override or "") < min_body and paras:
                    product.seo_text_override = (product.seo_text_override or "").rstrip() + "\n\n" + paras[idx % len(paras)].strip()
                    idx += 1
                changed = True

            # FAQ (seo_faq_override)
            if force or _faq_count(product.seo_faq_override or "") < min_faq:
                product.seo_faq_override = generate_faq("product")
                changed = True

            # Fill description_ru if empty (from seo_description_override or seo_intro_override)
            description_ru_filled = False
            _DESCRIPTION_RU_MAX = 500
            if not (product.description_ru or "").strip():
                source = (product.seo_description_override or product.seo_intro_override or "").strip()
                if source:
                    plain = strip_tags(source).strip()
                    if len(plain) > _DESCRIPTION_RU_MAX:
                        plain = plain[: _DESCRIPTION_RU_MAX - 3].rsplit(maxsplit=1)[0] + "..."
                    if plain:
                        product.description_ru = plain
                        changed = True
                        description_ru_filled = True

            if changed:
                updated += 1
                if not dry_run:
                    update_fields = [
                        "seo_title_override",
                        "seo_description_override",
                        "seo_text_override",
                        "seo_faq_override",
                    ]
                    if description_ru_filled:
                        update_fields.append("description_ru")
                    product.save(update_fields=update_fields)
                self.stdout.write(f"  Updated Product: {product.slug}")

        return created, updated
