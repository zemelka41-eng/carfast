{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load catalog_format %}

{% block title %}
    CARFAST{% if selected_series and selected_series.slug == "shacman" %} — партнёр по технике SHACMAN{% endif %}
{% endblock %}
{% block meta_description %}Техника SHACMAN в наличии и под заказ. Подбор комплектации, поставка и сопровождение по РФ.{% endblock %}

{% block extra_head %}
<link rel="preload" href="/static/img/hero/shacman_mein.v3.webp" as="image">
{% endblock %}

{% block content %}
{# Hero for main page / — bg image + overlay; direct path so no stale manifest (versioning via v3) #}
<section class="hero hero--shacman mb-5" data-hero-bg="shacman_mein.v3.webp">
    <span class="visually-hidden" id="hero-marker-20260203-v3">hero-bg-v3</span>
    <div class="hero__bg" aria-hidden="true">
        <img
            src="/static/img/hero/shacman_mein.v3.webp"
            alt=""
            decoding="async"
            fetchpriority="high"
            class="hero__bg-img"
        >
    </div>
    <div class="hero__overlay" aria-hidden="true"></div>
    <div class="container hero__content">
        <div class="surface p-4 p-lg-5">
            <div class="row g-4 align-items-center">
                <div class="col-lg-7">
                    <h1 class="display-5 fw-bold mb-3">
                        CARFAST{% if selected_series and selected_series.slug == "shacman" %} — официальный дилер <span class="text-accent">SHACMAN</span>{% endif %}
                    </h1>
                    <p class="lead mb-4 hero__subtitle">
                        Техника SHACMAN в наличии и под заказ. Подберём оптимальную комплектацию под вашу задачу и организуем поставку по РФ.
                    </p>
                    <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-accent btn-lg" href="{% url 'catalog:catalog_in_stock' %}">Техника в наличии</a>
                        <a class="btn btn-ghost btn-lg" href="{% url 'catalog:lead_page' %}">Получить КП</a>
                    </div>
                    {% if selected_series and selected_series.slug == "shacman" %}
                        <div class="mt-4 small text-muted">
                            Официальный статус подтверждён по бренду SHACMAN.
                        </div>
                    {% endif %}
                </div>
                <div class="col-lg-5">
                    {% include "partials/_hero_quick_actions.html" %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <div class="surface p-3 p-lg-4">
        <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="fw-bold">Официальный дилер SHACMAN</div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="fw-bold">Лизинг / помощь с оформлением</div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="fw-bold">Сервис и гарантия</div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="fw-bold">Доставка по РФ</div>
            </div>
        </div>
        <div class="mt-3">
            <div class="small text-muted mb-2">Подбор по задаче</div>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-ghost rounded-pill" href="{% url 'catalog:catalog_in_stock' %}">В наличии</a>
                {% if nav_category_list %}
                    {% for c in nav_category_list|slice:":8" %}
                        <a class="btn btn-sm btn-ghost rounded-pill" href="{% url 'catalog:catalog_category' slug=c.slug %}">
                            {{ c.name|clean_text }}
                        </a>
                    {% endfor %}
                {% elif nav_series_list %}
                    {% for s in nav_series_list|slice:":6" %}
                        <a class="btn btn-sm btn-ghost rounded-pill" href="{% url 'catalog:catalog_series' slug=s.slug %}">
                            {{ s.name|clean_text }}
                        </a>
                    {% endfor %}
                {% else %}
                    <a class="btn btn-sm btn-ghost rounded-pill" href="{% url 'catalog:catalog_in_stock' %}">Каталог</a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
        <div>
            <h2 class="h3 mb-1">Направления</h2>
            <div class="text-muted">Ключевые направления работы CARFAST.</div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-6 col-md-4">
            <a class="card-dark h-100 d-block text-decoration-none p-3" href="{% url 'catalog:parts' %}">
                <div class="fw-bold">Запчасти</div>
                <div class="small text-muted mt-2">Оригинал и аналоги, быстрый подбор.</div>
            </a>
        </div>
        <div class="col-6 col-md-4">
            <a class="card-dark h-100 d-block text-decoration-none p-3" href="{% url 'catalog:service' %}">
                <div class="fw-bold">Сервис</div>
                <div class="small text-muted mt-2">Диагностика и обслуживание техники.</div>
            </a>
        </div>
        <div class="col-6 col-md-4">
            <a class="card-dark h-100 d-block text-decoration-none p-3" href="{% url 'catalog:leasing' %}">
                <div class="fw-bold">Лизинг</div>
                <div class="small text-muted mt-2">Подбор программы и сопровождение.</div>
            </a>
        </div>
        <div class="col-6 col-md-4">
            <a class="card-dark h-100 d-block text-decoration-none p-3" href="{% url 'catalog:used' %}">
                <div class="fw-bold">Б/У техника</div>
                <div class="small text-muted mt-2">Проверенные предложения в наличии.</div>
            </a>
        </div>
        <div class="col-6 col-md-4">
            <a class="card-dark h-100 d-block text-decoration-none p-3" href="{% url 'catalog:payment_delivery' %}">
                <div class="fw-bold">Оплата и доставка</div>
                <div class="small text-muted mt-2">Условия поставки и логистика.</div>
            </a>
        </div>
        <div class="col-6 col-md-4">
            <a class="card-dark h-100 d-block text-decoration-none p-3" href="{% url 'blog:blog_list' %}">
                <div class="fw-bold">Блог</div>
                <div class="small text-muted mt-2">Новости и материалы по технике.</div>
            </a>
        </div>
    </div>
</section>

{% include "partials/_cta_strip.html" %}

<section class="mb-5">
    <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
        <div>
            <h2 class="h3 mb-1">Как мы работаем</h2>
            <div class="text-muted">Прозрачный процесс от подбора до выдачи техники.</div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card-dark h-100 p-3">
                <div class="small text-accent fw-bold mb-2">01</div>
                <div class="fw-bold">Подбор по задаче</div>
                <div class="small text-muted mt-2">Уточняем требования и подбираем комплектацию.</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card-dark h-100 p-3">
                <div class="small text-accent fw-bold mb-2">02</div>
                <div class="fw-bold">КП и сроки</div>
                <div class="small text-muted mt-2">Формируем КП, согласуем цену и сроки.</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card-dark h-100 p-3">
                <div class="small text-accent fw-bold mb-2">03</div>
                <div class="fw-bold">Договор / оплата / лизинг</div>
                <div class="small text-muted mt-2">Подписываем договор и сопровождаем оплату.</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card-dark h-100 p-3">
                <div class="small text-accent fw-bold mb-2">04</div>
                <div class="fw-bold">Доставка / выдача / сервис</div>
                <div class="small text-muted mt-2">Организуем логистику и дальнейший сервис.</div>
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
        <div>
            <h2 class="h3 mb-1">FAQ</h2>
            <div class="text-muted">Ответы на частые вопросы.</div>
        </div>
    </div>
    <div class="accordion" id="homeFaq">
        <div class="accordion-item surface-2 mb-2">
            <h3 class="accordion-header" id="faqOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseOne" aria-expanded="false" aria-controls="faqCollapseOne">
                    Срок поставки “в наличии” и “под заказ”
                </button>
            </h3>
            <div id="faqCollapseOne" class="accordion-collapse collapse" aria-labelledby="faqOne" data-bs-parent="#homeFaq">
                <div class="accordion-body text-muted">
                    В наличии — ближайшая выдача, под заказ — сроки согласуем в КП.
                </div>
            </div>
        </div>
        <div class="accordion-item surface-2 mb-2">
            <h3 class="accordion-header" id="faqTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseTwo" aria-expanded="false" aria-controls="faqCollapseTwo">
                    Что нужно для КП
                </button>
            </h3>
            <div id="faqCollapseTwo" class="accordion-collapse collapse" aria-labelledby="faqTwo" data-bs-parent="#homeFaq">
                <div class="accordion-body text-muted">
                    Описание задачи, регион доставки и желаемые сроки.
                </div>
            </div>
        </div>
        <div class="accordion-item surface-2 mb-2">
            <h3 class="accordion-header" id="faqThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseThree" aria-expanded="false" aria-controls="faqCollapseThree">
                    Лизинг: какие документы
                </button>
            </h3>
            <div id="faqCollapseThree" class="accordion-collapse collapse" aria-labelledby="faqThree" data-bs-parent="#homeFaq">
                <div class="accordion-body text-muted">
                    Стандартный пакет юрлица. Список уточним под лизинг-одобрение.
                </div>
            </div>
        </div>
        <div class="accordion-item surface-2 mb-2">
            <h3 class="accordion-header" id="faqFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseFour" aria-expanded="false" aria-controls="faqCollapseFour">
                    Доставка по РФ
                </button>
            </h3>
            <div id="faqCollapseFour" class="accordion-collapse collapse" aria-labelledby="faqFour" data-bs-parent="#homeFaq">
                <div class="accordion-body text-muted">
                    Организуем логистику до вашего региона с контролем сроков.
                </div>
            </div>
        </div>
        <div class="accordion-item surface-2 mb-2">
            <h3 class="accordion-header" id="faqFive">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseFive" aria-expanded="false" aria-controls="faqCollapseFive">
                    Гарантия и сервис
                </button>
            </h3>
            <div id="faqCollapseFive" class="accordion-collapse collapse" aria-labelledby="faqFive" data-bs-parent="#homeFaq">
                <div class="accordion-body text-muted">
                    Гарантийные обязательства и сервисное сопровождение прописываются в договоре.
                </div>
            </div>
        </div>
        <div class="accordion-item surface-2 mb-2">
            <h3 class="accordion-header" id="faqSix">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseSix" aria-expanded="false" aria-controls="faqCollapseSix">
                    Как проверить комплектацию
                </button>
            </h3>
            <div id="faqCollapseSix" class="accordion-collapse collapse" aria-labelledby="faqSix" data-bs-parent="#homeFaq">
                <div class="accordion-body text-muted">
                    Присылаем спецификацию и подтверждаем комплектацию перед поставкой.
                </div>
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
        <div>
            <h2 class="h3 mb-1">Категории техники</h2>
            <div class="text-muted">Подбор спецтехники под задачу — от самосвалов до тягачей и шасси.</div>
        </div>
    </div>

    <div class="row g-3">
        {% for c in nav_category_list %}
            <div class="col-6 col-md-4 col-lg-3">
                <a class="card-dark h-100 d-block text-decoration-none category-card {% if c.cover_image %}category-card--has-cover{% endif %}"
                   href="{% url 'catalog:catalog_category' slug=c.slug %}">
                    {% if c.cover_image %}
                        <img class="category-card__img" src="{{ c.cover_image.url }}" alt="{{ c.cover_alt_ru|default:c.name|clean_text }}" loading="lazy">
                        <div class="category-card__overlay" aria-hidden="true"></div>
                    {% endif %}
                    <div class="category-card__content p-3">
                        <div class="fw-bold">{{ c.name|clean_text }}</div>
                        <div class="small category-card__hint mt-2">Смотреть позиции</div>
                    </div>
                </a>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="surface p-4 p-lg-5 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                    <div>
                        <div class="h4 mb-1">Подберём технику под задачу</div>
                        <div class="text-muted">Подберём комплектацию, сроки и условия поставки. Ответим быстро.</div>
                    </div>
                    <div class="d-flex gap-2 flex-shrink-0">
                        <a class="btn btn-accent btn-lg" href="{% url 'catalog:lead_page' %}">Получить КП</a>
                        <a class="btn btn-ghost btn-lg" href="{{ contact_whatsapp_href }}" target="_blank" rel="noopener noreferrer">WhatsApp</a>
                        <a class="btn btn-ghost btn-lg" href="{{ contact_telegram_href }}" target="_blank" rel="noopener noreferrer">Telegram</a>
                        {% if contact_max_href %}
                            <a class="btn btn-ghost btn-lg" href="{{ contact_max_href }}" target="_blank" rel="noopener noreferrer">MAX</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</section>

{% if in_stock_products %}
<section class="mb-5">
    <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
        <div>
            <h2 class="h3 mb-1">В наличии сейчас</h2>
            <div class="text-muted">Подборка техники, доступной к поставке без ожидания.</div>
        </div>
        <a class="btn btn-ghost" href="{% url 'catalog:catalog_in_stock' %}">Смотреть весь каталог</a>
    </div>

    <div class="row g-3 align-items-stretch">
        {% for product in in_stock_products %}
            <div class="col-md-6 col-lg-4 d-flex">
                {% include "catalog/_product_card.html" with product=product variant="home" %}
            </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="mb-5">
    <div class="d-flex align-items-end justify-content-between gap-3 mb-3">
        <div>
            <h2 class="h3 mb-1">Популярные позиции</h2>
            <div class="text-muted">Техника, которую чаще всего запрашивают прямо сейчас.</div>
        </div>
    </div>

    <div class="row g-3 align-items-stretch">
        {% for product in products %}
            <div class="col-md-6 col-lg-4 d-flex">
                {% include "catalog/_product_card.html" with product=product variant="home" %}
            </div>
        {% empty %}
            <div class="col-12">
                <div class="surface p-4 p-lg-5 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                    <div>
                        <div class="h4 mb-1">Подберём технику под задачу</div>
                        <div class="text-muted">Подберём комплектацию, сроки и условия поставки. Ответим быстро.</div>
                    </div>
                    <div class="d-flex gap-2 flex-shrink-0">
                        <a class="btn btn-accent btn-lg" href="{% url 'catalog:lead_page' %}">Получить КП</a>
                        <a class="btn btn-ghost btn-lg" href="{{ contact_whatsapp_href }}" target="_blank" rel="noopener noreferrer">WhatsApp</a>
                        <a class="btn btn-ghost btn-lg" href="{{ contact_telegram_href }}" target="_blank" rel="noopener noreferrer">Telegram</a>
                        {% if contact_max_href %}
                            <a class="btn btn-ghost btn-lg" href="{{ contact_max_href }}" target="_blank" rel="noopener noreferrer">MAX</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</section>

<section>
    <div class="surface p-4 p-lg-5 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
        <div>
            <div class="h3 mb-1">Нужно коммерческое предложение под вашу задачу?</div>
            <div class="text-muted">Подберём комплектацию, сроки и условия поставки. Ответим быстро.</div>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-accent btn-lg" href="{% url 'catalog:lead_page' %}">Получить КП</a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modalEl = document.getElementById("benefitModal");
    if (!modalEl) return;

    modalEl.addEventListener("show.bs.modal", function (event) {
      const trigger = event.relatedTarget;
      if (!trigger) return;

      let title = trigger.getAttribute("data-title") || "";
      let text = trigger.getAttribute("data-text") || "";
      
      // Clean artifacts: remove markdown header artifacts (leading #+spaces and sequences of 3+ hash symbols)
      // Remove leading hash symbols with optional spaces: ^\s*#{1,}\s*
      // Also remove any sequences of 3+ hash symbols anywhere in the string
      title = title.replace(/^\s*#{1,}\s*/g, "").replace(/#{3,}/g, "").trim();
      text = text.replace(/^\s*#{1,}\s*/g, "").replace(/#{3,}/g, "").trim();

      const titleEl = modalEl.querySelector(".modal-title");
      const textEl = modalEl.querySelector(".benefit-modal__text");

      // Set title with fallback, ensure no artifacts remain
      if (titleEl) {
        const finalTitle = title || "Преимущество";
        // Final safety check: remove any remaining hash sequences (including 5+ hashes like "#####")
        const cleanedTitle = finalTitle.replace(/#{3,}/g, "").replace(/^\s*#{1,}\s*/g, "").trim() || "Преимущество";
        titleEl.textContent = cleanedTitle;
      }
      if (textEl) {
        // Clean text as well
        const cleanedText = text.replace(/#{3,}/g, "").replace(/^\s*#{1,}\s*/g, "").trim();
        textEl.textContent = cleanedText;
      }
    });
  });
</script>
{% endblock %}

