{% load i18n %}
{% load static %}
{% load build_id %}
{% load catalog_format %}
<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% if meta_title %}{{ meta_title|clean_text }}{% else %}CARFAST{% endif %}{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{{ meta_description|default:"Премиальный каталог спецтехники CARFAST"|clean_text }}{% endblock %}">
    <link rel="icon" href="{% static 'favicons/favicon.ico' %}?v={% get_build_id %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicons/favicon-32x32.png' %}?v={% get_build_id %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicons/favicon-16x16.png' %}?v={% get_build_id %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'favicons/apple-touch-icon.png' %}?v={% get_build_id %}">
    <link rel="manifest" href="{% static 'favicons/site.webmanifest' %}?v={% get_build_id %}">
    <meta name="theme-color" content="#000000">
    {% if meta_robots %}<meta name="robots" content="{{ meta_robots }}">{% endif %}
    {% if canonical %}<link rel="canonical" href="{{ canonical }}">{% endif %}
    {% if hreflang_ru %}<link rel="alternate" hreflang="ru" href="{{ hreflang_ru }}">{% endif %}
    {% if hreflang_en %}<link rel="alternate" hreflang="en" href="{{ hreflang_en }}">{% endif %}
    
    {# OpenGraph meta tags #}
    {% if og_title %}<meta property="og:title" content="{{ og_title|clean_text }}">{% endif %}
    {% if og_description %}<meta property="og:description" content="{{ og_description|clean_text }}">{% endif %}
    {% if og_url %}<meta property="og:url" content="{{ og_url }}">{% endif %}
    {% if og_type %}<meta property="og:type" content="{{ og_type }}">{% endif %}
    {% if og_image %}<meta property="og:image" content="{{ og_image }}">{% endif %}
    <meta property="og:site_name" content="CARFAST">
    <meta property="og:locale" content="ru_RU">
    
    {# Twitter Card meta tags #}
    {% if twitter_card %}<meta name="twitter:card" content="{{ twitter_card }}">{% endif %}
    {% if og_title %}<meta name="twitter:title" content="{{ og_title|clean_text }}">{% endif %}
    {% if og_description %}<meta name="twitter:description" content="{{ og_description|clean_text }}">{% endif %}
    {% if og_image %}<meta name="twitter:image" content="{{ og_image }}">{% endif %}
    
    {# JSON-LD: only on clean URLs; 404 sets schema_disabled=True and schema_allowed=False #}
    {% if request and not request.GET and schema_allowed|default:False and not schema_disabled|default:False %}
    <script type="application/ld+json">
    [
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "@id": "https://carfst.ru/#organization",
            "name": "CARFAST",
            "legalName": "ООО «Карфаст»",
            "url": "https://carfst.ru/"{% if site_settings and site_settings.phone or contact_phone_display %},
            "telephone": "{{ site_settings.phone|default:contact_phone_display }}"{% endif %}{% if contact_email_display or contact_email_href %},
            "email": "{{ contact_email_display|default:'info@carfst.ru' }}"{% endif %}{% if contact_phone_display or contact_email_display %},
            "contactPoint": [
                {
                    "@type": "ContactPoint",
                    "contactType": "sales",
                    "telephone": "{{ site_settings.phone|default:contact_phone_display }}"{% if contact_email_display %},
                    "email": "{{ contact_email_display|default:'info@carfst.ru' }}"{% endif %}
                }
            ]{% endif %}{% if company_addresses %},
            "address": [
                {% for addr in company_addresses %}
                {
                    "@type": "PostalAddress",
                    "addressCountry": "RU",
                    "streetAddress": "{{ addr.full_address }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]{% endif %}{% if contact_whatsapp_href or contact_telegram_href or contact_max_href %},
            "sameAs": [
                {% if contact_whatsapp_href %}"{{ contact_whatsapp_href }}"{% endif %}{% if contact_telegram_href %}{% if contact_whatsapp_href %}, {% endif %}"{{ contact_telegram_href }}"{% endif %}{% if contact_max_href %}{% if contact_whatsapp_href or contact_telegram_href %}, {% endif %}"{{ contact_max_href }}"{% endif %}
            ]{% endif %}
        },
        {{ local_business_schema_json|safe }},
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "@id": "https://carfst.ru/#website",
            "url": "https://carfst.ru/",
            "name": "CARFAST",
            "publisher": { "@id": "https://carfst.ru/#organization" }{% if search_action_target %},
            "potentialAction": {
                "@type": "SearchAction",
                "target": "{{ search_action_target }}",
                "query-input": "required name=search_term_string"
            }{% endif %}
        }{% if page_schema_payload and schema_allowed|default:False %},
        {{ page_schema_payload|safe }}{% endif %}
    ]
    </script>
    {% endif %}

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}
            m[i].l=1*new Date()
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106366435', 'ym');

        window.dataLayer = window.dataLayer || [];

        ym(106366435, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});
    </script>
    <!-- /Yandex.Metrika counter -->
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/tokens.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
      /* Hotfix: limit product card description to 2 lines even if static build isn't refreshed yet */
      .product-card__description,
      .product-card-description {
        -webkit-line-clamp: 2;
        line-clamp: 2;
        min-height: calc(1.5em * 2);
      }
    </style>
    {% block extra_css %}{% endblock %}
    {% block extra_head %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100 has-cookie-consent {% block body_class %}{% endblock %}">
    <!-- Yandex.Metrika counter -->
    <noscript><div><img src="https://mc.yandex.ru/watch/106366435" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <header class="site-header" role="banner">
        <div class="site-topbar py-2">
            <div class="container d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <a class="topbar-link small" href="{{ contact_phone_href }}">
                        <span class="text-accent fw-bold">Тел.</span> {{ contact_phone_display }}
                    </a>

                    <div class="d-flex align-items-center gap-2">
                        <a class="topbar-icon" href="{{ contact_whatsapp_href }}" target="_blank" rel="noopener noreferrer" aria-label="Написать в WhatsApp">
                            <span class="visually-hidden">WhatsApp</span>
                            <svg viewBox="0 0 32 32" width="18" height="18" aria-hidden="true" focusable="false">
                                <path fill="currentColor" d="M19.11 17.37c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.6.14-.18.27-.7.88-.86 1.06-.16.18-.32.2-.6.07-.27-.14-1.16-.43-2.21-1.36-.82-.73-1.37-1.63-1.53-1.9-.16-.27-.02-.42.12-.56.12-.12.27-.32.4-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.6-1.46-.82-2-.21-.51-.43-.44-.6-.45h-.52c-.18 0-.48.07-.73.34-.25.27-.95.93-.95 2.27 0 1.34.98 2.63 1.11 2.82.14.18 1.93 2.95 4.68 4.14.65.28 1.16.45 1.56.58.65.21 1.24.18 1.71.11.52-.08 1.6-.65 1.82-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32ZM16.02 27.84h-.01c-1.98 0-3.92-.53-5.62-1.53l-.4-.24-4.16 1.09 1.11-4.06-.26-.42A11.77 11.77 0 0 1 4.25 16c0-6.49 5.28-11.77 11.77-11.77 3.15 0 6.11 1.23 8.34 3.45A11.72 11.72 0 0 1 27.8 16c0 6.49-5.29 11.84-11.78 11.84Zm9.98-20.18A14.02 14.02 0 0 0 16.02 2C8.28 2 2 8.28 2 16c0 2.47.65 4.88 1.88 7.01L2 30l7.17-1.88A13.94 13.94 0 0 0 16.02 30C23.72 30 30 23.72 30 16c0-3.74-1.46-7.26-4-9.34Z"/>
                            </svg>
                        </a>
                        <a class="topbar-icon" href="{{ contact_telegram_href }}" target="_blank" rel="noopener noreferrer" aria-label="Написать в Telegram">
                            <span class="visually-hidden">Telegram</span>
                            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                                <path fill="currentColor" d="M9.73 15.24 9.5 19.1c.39 0 .56-.17.76-.37l1.82-1.75 3.77 2.76c.69.38 1.18.18 1.35-.64l2.45-11.52c.21-1.01-.36-1.41-1.03-1.16L4.21 10.1c-.97.38-.96.92-.17 1.17l3.72 1.16 8.63-5.45c.41-.27.78-.12.47.15"/>
                            </svg>
                        </a>
                        {% if contact_max_href %}
                            <a class="topbar-icon" href="{{ contact_max_href }}" target="_blank" rel="noopener noreferrer" aria-label="Написать в MAX">
                                <span aria-hidden="true" class="small fw-bold">MAX</span>
                            </a>
                        {% endif %}
                    </div>

                    <a class="topbar-link small" href="{{ contact_email_href|default:'mailto:info@carfst.ru' }}">
                        <span class="text-accent fw-bold">Email</span> {{ contact_email_display|default:"info@carfst.ru" }}
                    </a>
                </div>
                <div class="d-none d-md-block">
                    {% if selected_series and selected_series.slug == "shacman" %}
                        <span class="badge badge-accent">CARFAST — официальный дилер SHACMAN</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-dark bg-black py-3">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="{% url 'catalog:home' %}">
                <img
                    class="brand-logo"
                    src="{% static 'img/logo-h64.webp' %}?v={% get_build_id %}"
                    srcset="{% static 'img/logo-h64.webp' %}?v={% get_build_id %} 1x, {% static 'img/logo-h128.webp' %}?v={% get_build_id %} 2x"
                    height="40"
                    alt="CARFAST"
                    loading="eager"
                    decoding="async"
                >
                <span class="d-flex flex-column lh-1">
                    <span class="brand-mark">CARFAST</span>
                    {% if selected_series and selected_series.slug == "shacman" %}
                        <span class="brand-sub">Официальный дилер SHACMAN</span>
                    {% endif %}
                </span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Переключить навигацию">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.view_name == 'catalog:catalog_in_stock' or request.resolver_match.view_name == 'catalog:catalog_list' or request.resolver_match.view_name == 'catalog:product_detail' %}active{% endif %}"
                           href="{% url 'catalog:catalog_in_stock' %}"
                           {% if request.resolver_match.view_name == 'catalog:catalog_in_stock' or request.resolver_match.view_name == 'catalog:catalog_list' or request.resolver_match.view_name == 'catalog:product_detail' %}aria-current="page"{% endif %}>
                            Каталог
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.view_name == 'catalog:parts' %}active{% endif %}"
                           href="{% url 'catalog:parts' %}"
                           {% if request.resolver_match.view_name == 'catalog:parts' %}aria-current="page"{% endif %}>
                            Запчасти
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if request.resolver_match.view_name == 'catalog:service' or request.resolver_match.view_name == 'catalog:leasing' or request.resolver_match.view_name == 'catalog:payment_delivery' %}active{% endif %}"
                           href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Услуги
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="{% url 'catalog:service' %}">Сервис</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'catalog:leasing' %}">Лизинг</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'catalog:payment_delivery' %}">Оплата и доставка</a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.view_name == 'catalog:used' %}active{% endif %}"
                           href="{% url 'catalog:used' %}"
                           {% if request.resolver_match.view_name == 'catalog:used' %}aria-current="page"{% endif %}>
                            Б/У техника
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.view_name == 'blog:blog_list' or request.resolver_match.view_name == 'blog:blog_detail' %}active{% endif %}"
                           href="{% url 'blog:blog_list' %}"
                           {% if request.resolver_match.view_name == 'blog:blog_list' or request.resolver_match.view_name == 'blog:blog_detail' %}aria-current="page"{% endif %}>
                            Блог
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.view_name == 'catalog:about' %}active{% endif %}"
                           href="{% url 'catalog:about' %}"
                           {% if request.resolver_match.view_name == 'catalog:about' %}aria-current="page"{% endif %}>
                            О компании
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.view_name == 'catalog:contacts' %}active{% endif %}"
                           href="{% url 'catalog:contacts' %}"
                           {% if request.resolver_match.view_name == 'catalog:contacts' %}aria-current="page"{% endif %}>
                            Контакты
                        </a>
                    </li>
                </ul>
                <div class="ms-lg-3 mt-3 mt-lg-0 d-grid d-lg-block">
                    <a class="btn btn-accent btn-lg" href="{% url 'catalog:lead_page' %}">Получить КП</a>
                </div>
            </div>
        </div>
        </nav>
    </header>

    <main class="container flex-grow-1 py-4 py-lg-5">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <footer class="mt-auto pt-5 pb-4">
        <div class="container">
            <div class="surface-2 p-4 p-lg-5">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="brand-mark">CARFAST</div>
                        {% if selected_series and selected_series.slug == "shacman" %}
                            <div class="brand-sub mt-2">Официальный дилер SHACMAN</div>
                        {% endif %}
                        <div class="small text-muted mt-2">ООО «Карфаст»</div>
                        <hr class="hr-dim my-3">
                        <div class="d-flex flex-column gap-2">
                            {% if company_addresses %}
                                {% for addr in company_addresses %}
                                    <div class="text-muted small">
                                        <span class="fw-bold">
                                            {% if addr.label %}{{ addr.label }}{% elif addr.title %}{{ addr.title }}{% elif forloop.first %}Офис (МО){% else %}Главный офис дилера (Саратов){% endif %}:
                                        </span>
                                        {{ addr.full_address }}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-muted small">
                                    <span class="fw-bold">Офис (МО):</span>
                                    Новорязанское ш., 6, Котельники, Московская обл., 140054
                                </div>
                                <div class="text-muted small">
                                    <span class="fw-bold">Главный офис дилера (Саратов):</span>
                                    410005, Саратовская область, г. Саратов, ул. Б.Садовая, дом 239, БЦ «Навигатор», офис 501
                                </div>
                            {% endif %}
                            <a class="link-muted link-accent-hover" href="{{ contact_phone_href }}">
                                <span class="text-accent fw-bold">Тел.</span> {{ contact_phone_display }}
                            </a>
                            <a class="link-muted link-accent-hover" href="{{ contact_whatsapp_href }}" target="_blank" rel="noopener noreferrer">WhatsApp</a>
                            <a class="link-muted link-accent-hover" href="{{ contact_telegram_href }}" target="_blank" rel="noopener noreferrer">Telegram</a>
                            {% if contact_max_href %}
                                <a class="link-muted link-accent-hover" href="{{ contact_max_href }}" target="_blank" rel="noopener noreferrer">MAX</a>
                            {% endif %}
                            <a class="link-muted link-accent-hover" href="{{ contact_email_href|default:'mailto:info@carfst.ru' }}">{{ contact_email_display|default:"info@carfst.ru" }}</a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-uppercase small text-muted mb-2">Быстрые ссылки</div>
                        <ul class="list-unstyled mb-0 d-grid gap-2">
                            <li><a class="link-muted link-accent-hover" href="{% url 'catalog:catalog_in_stock' %}">Каталог</a></li>
                            <li><a class="link-muted link-accent-hover" href="{% url 'catalog:about' %}">О компании</a></li>
                            <li><a class="link-muted link-accent-hover" href="{% url 'catalog:contacts' %}">Контакты</a></li>
                            <li><a class="link-muted link-accent-hover" href="{% url 'catalog:privacy' %}">Политика конфиденциальности</a></li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <div class="text-uppercase small text-muted mb-2">Коммерческое предложение</div>
                        <p class="text-muted mb-3">
                            Подберём технику под задачу и бюджет. Ответим быстро, без лишних вопросов.
                        </p>
                        <a class="btn btn-accent btn-lg w-100" href="{% url 'catalog:lead_page' %}">Получить КП</a>
                    </div>
                </div>
                <hr class="hr-dim my-4">
                <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                    <div class="small text-muted">&copy; {% now "Y" %} CARFAST <span class="text-muted" style="opacity: 0.5;">|</span> <span class="text-muted" style="font-size: 0.85em;">build: {% get_build_id %}</span></div>
                    {% if selected_series and selected_series.slug == "shacman" %}
                        <div class="small text-muted">
                            Официальный статус подтверждаем документально — по запросу в разделе «Контакты».
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </footer>

    <div id="cookie-consent" class="cookie-consent" role="region" aria-label="Cookie consent">
        <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
            <div class="text-muted small">
                Используем cookies для корректной работы сайта и аналитики. Подробнее — в
                <a class="link-muted link-accent-hover" href="{% url 'catalog:privacy' %}">политике конфиденциальности</a>.
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-ghost btn-sm" type="button" data-cookie-necessary>Только необходимые</button>
                <button class="btn btn-accent btn-sm" type="button" data-cookie-all>Принять все</button>
                <button class="btn btn-ghost btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#cookie-settings" aria-expanded="false" aria-controls="cookie-settings">
                    Настроить
                </button>
            </div>
        </div>
        <div class="collapse" id="cookie-settings">
            <div class="container small text-muted mt-2">
                Необходимые cookies нужны для работы сайта. Аналитические помогают улучшать сервис. Вы можете выбрать “Только необходимые”
                или “Принять все”.
            </div>
        </div>
        <noscript>
            <div class="container small text-muted mt-2">
                Без JavaScript баннер остаётся видимым.
            </div>
        </noscript>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/product-card-link.js' %}"></script>
    <script src="{% static 'js/cookie-consent.js' %}" defer></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
